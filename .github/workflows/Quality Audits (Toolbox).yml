name: Quality Audits (Toolbox).yml

# Objectif : tester les outils de la boÃ®te Ã  outils CI/CD
# RÃ©fÃ©rentiel RNCP : Ce2.2.4 (sÃ©curitÃ©), Ce2.3.5 (accessibilitÃ©), Ce2.3.3 (performance/SEO)


on:
  pull_request:
    branches: ["main"]
  push:
    branches: ["feature/**"]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # JOB 1 : size-limit - Budget de performance bundle
  # Remplace bundlephobia (CLI non disponible) pour l'usage CI
  # RÃ©fÃ©rentiel : Ce2.3.3 (Ã©co-conception, performance)
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  bundle-size:
    name: ðŸ“¦ Bundle Size Budget
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: ðŸ“¦ Install dependencies
        run: |
          npm ci
          if ! npm list @rollup/rollup-linux-x64-gnu > /dev/null 2>&1; then
            echo "âš ï¸ Rollup optional dependency missing, reinstalling..."
            rm -rf node_modules package-lock.json
            npm install --include=optional
          fi

      - name: ðŸ—ï¸ Build
        run: npm run build
        env:
          ROLLUP_SKIP_NODE_NATIVE: "true"
          VITE_API_SERVER_URL: "https://mock-api.example.com"
          VITE_REDIRECT_URI: "https://mock.example.com"
          VITE_API_V1: "/v1"
          VITE_API_V2: "/v2"

      - name: ðŸ“Š Analyse bundle avec vite-bundle-visualizer
        run: |
          echo "=== Taille du bundle produit ==="
          du -sh dist/assets/*.js 2>/dev/null | sort -h || echo "Pas de JS dans dist/assets"
          du -sh dist/assets/*.css 2>/dev/null | sort -h || echo "Pas de CSS dans dist/assets"
          echo ""
          echo "=== Total dist/ ==="
          du -sh dist/
          echo ""
          echo "=== Objectif : < 600kb gzipped (planning_ameliorations_v2.md) ==="
          # Calcul taille gzippÃ©e approximative
          total_gz=$(find dist -name "*.js" -o -name "*.css" | xargs gzip -c | wc -c)
          echo "Taille gzippÃ©e estimÃ©e : $(echo $total_gz | awk '{printf "%.0f KB", $1/1024}')"
        continue-on-error: true

      - name: ðŸ” Vite bundle visualizer (rapport HTML)
        run: npx vite-bundle-visualizer --open false 2>/dev/null || echo "vite-bundle-visualizer non disponible, utiliser source-map-explorer"
        continue-on-error: true

