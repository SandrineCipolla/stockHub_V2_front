name: Quality Audits (Toolbox).yml

# Objectif : tester les outils de la boÃ®te Ã  outils CI/CD
# RÃ©fÃ©rentiel RNCP : Ce2.2.4 (sÃ©curitÃ©), Ce2.3.5 (accessibilitÃ©), Ce2.3.3 (performance/SEO)


on:
  pull_request:
    branches: ["main"]
  push:
    branches: ["feature/**"]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # JOB 1 : size-limit - Budget de performance bundle
  # Remplace bundlephobia (CLI non disponible) pour l'usage CI
  # RÃ©fÃ©rentiel : Ce2.3.3 (Ã©co-conception, performance)
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  bundle-size:
    name: ğŸ“¦ Bundle Size Budget
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: ğŸ“¦ Install dependencies
        run: |
          npm ci
          if ! npm list @rollup/rollup-linux-x64-gnu > /dev/null 2>&1; then
            echo "âš ï¸ Rollup optional dependency missing, reinstalling..."
            rm -rf node_modules package-lock.json
            npm install --include=optional
          fi

      - name: ğŸ—ï¸ Build
        run: npm run build
        env:
          ROLLUP_SKIP_NODE_NATIVE: "true"
          VITE_API_SERVER_URL: "https://mock-api.example.com"
          VITE_REDIRECT_URI: "https://mock.example.com"
          VITE_API_V1: "/v1"
          VITE_API_V2: "/v2"

      - name: ğŸ“Š Analyse bundle avec vite-bundle-visualizer
        run: |
          echo "=== Taille du bundle produit ==="
          du -sh dist/assets/*.js 2>/dev/null | sort -h || echo "Pas de JS dans dist/assets"
          du -sh dist/assets/*.css 2>/dev/null | sort -h || echo "Pas de CSS dans dist/assets"
          echo ""
          echo "=== Total dist/ ==="
          du -sh dist/
          echo ""
          echo "=== Objectif : < 600kb gzipped (planning_ameliorations_v2.md) ==="
          # Calcul taille gzippÃ©e approximative
          total_gz=$(find dist -name "*.js" -o -name "*.css" | xargs gzip -c | wc -c)
          echo "Taille gzippÃ©e estimÃ©e : $(echo $total_gz | awk '{printf "%.0f KB", $1/1024}')"
        continue-on-error: true

      - name: ğŸ” Vite bundle visualizer (rapport HTML)
        run: |
          mkdir -p bundle-report
           # Capturer stdout pour extraire "Generated at /tmp/..."
           OUTPUT=$(npx vite-bundle-visualizer --open false 2>&1)
          echo "$OUTPUT"
          STATS_PATH=$(echo "$OUTPUT" | grep "Generated at" | awk '{print $NF}')
          echo "Chemin dÃ©tectÃ© : $STATS_PATH"
          if [ -n "$STATS_PATH" ] && [ -f "$STATS_PATH" ]; then
            cp "$STATS_PATH" bundle-report/stats.html
            echo "âœ… stats.html copiÃ©"
          else
             echo "âš ï¸ Copie Ã©chouÃ©e"
          fi
        continue-on-error: true

      - name: ğŸ“¤ Upload bundle report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: bundle-size-report
          path: bundle-report/stats.html
          retention-days: 7

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # JOB 2 : Lighthouse CI (Performance + AccessibilitÃ© + SEO + Best Practices)
  # RÃ©fÃ©rentiel : Ce2.3.3 (performance), Ce2.3.5 (accessibilitÃ©)
  # Couvre aussi le "Lighthouse SEO" mentionnÃ© dans la boÃ®te Ã  outils
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  lighthouse-ci:
    name: ğŸ  Lighthouse CI (Perf + A11y + SEO)
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: ğŸ“¦ Install dependencies
        run: |
          npm ci
          if ! npm list @rollup/rollup-linux-x64-gnu > /dev/null 2>&1; then
            echo "âš ï¸ Rollup optional dependency missing, reinstalling..."
            rm -rf node_modules package-lock.json
            npm install --include=optional
          fi

      - name: ğŸ—ï¸ Build
        run: npm run build
        env:
          ROLLUP_SKIP_NODE_NATIVE: "true"
          VITE_API_SERVER_URL: "https://mock-api.example.com"
          VITE_REDIRECT_URI: "https://mock.example.com"
          VITE_API_V1: "/v1"
          VITE_API_V2: "/v2"

      - name: ğŸ”§ Install LHCI
        run: npm install -g @lhci/cli

      - name: ğŸš€ Serve dist locally
        run: |
          npm install -g serve
          serve -s dist -p 3000 &
          # Attendre que le serveur soit prÃªt
          npx wait-on http://localhost:3000 --timeout 30000

      - name: ğŸ  Run Lighthouse CI
        run: |
          lhci autorun \
            --collect.url=http://localhost:3000 \
            --collect.numberOfRuns=1 \
            --assert.assertions.categories:performance=warn \
            --assert.assertions.categories:accessibility=warn \
            --assert.assertions.categories:seo=warn \
            --assert.assertions.categories:best-practices=warn \
            --upload.target=temporary-public-storage
        # Note : --upload.target=temporary-public-storage envoie les rÃ©sultats
        # sur le stockage public temporaire LHCI (gratuit, 7 jours de rÃ©tention)
        # Alternative : utiliser un lhci-server auto-hÃ©bergÃ© pour historique
        continue-on-error: true
        # continue-on-error: true car c'est une phase d'expÃ©rimentation
        # Passer Ã  false quand les seuils sont stabilisÃ©s

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # JOB 3 : axe-core - Tests accessibilitÃ© automatisÃ©s
  # RÃ©fÃ©rentiel : Ce2.3.5
  # Rappel boÃ®te Ã  outils : valide ~25-30% d'un audit, reste = analyse humaine
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  axe-accessibility:
    name: â™¿ axe-core Accessibility
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: ğŸ“¦ Install dependencies
        run: |
          npm ci
          if ! npm list @rollup/rollup-linux-x64-gnu > /dev/null 2>&1; then
            echo "âš ï¸ Rollup optional dependency missing, reinstalling..."
            rm -rf node_modules package-lock.json
            npm install --include=optional
          fi

      - name: ğŸ—ï¸ Build
        run: npm run build
        env:
          ROLLUP_SKIP_NODE_NATIVE: "true"
          VITE_API_SERVER_URL: "https://mock-api.example.com"
          VITE_REDIRECT_URI: "https://mock.example.com"
          VITE_API_V1: "/v1"
          VITE_API_V2: "/v2"

      - name: ğŸ”§ Install axe-core CLI + serveur local
        run: |
          npm install -g @axe-core/cli serve
          npm install -g wait-on
          # Synchroniser Chrome et ChromeDriver pour Ã©viter le mismatch de versions
          npx browser-driver-manager install chrome

      - name: ğŸš€ Serve + Run axe
        run: |
          serve -s dist -p 3001 &
          npx wait-on http://localhost:3001 --timeout 30000
          echo "Lancement audit axe-core..."
          axe http://localhost:3001 --exit || true
          # --exit : code de sortie != 0 si violations trouvÃ©es
          # || true : ne pas faire Ã©chouer le workflow en phase expÃ©
        # Pour activer le blocage strict plus tard, retirer "|| true"
        continue-on-error: true

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # JOB 3 : TruffleHog - Scan de secrets dans le repo
  # RÃ©fÃ©rentiel : Ce2.2.4 (sÃ©curitÃ©)
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  trufflehog-security:
    name: ğŸ” TruffleHog - Secret Scanning
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout (full history pour scan complet)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          # fetch-depth: 0 = historique complet nÃ©cessaire pour TruffleHog

      - name: ğŸ” TruffleHog OSS Scan
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: main
          head: HEAD
          extra_args: --only-verified
          # --only-verified : ne remonte que les secrets vÃ©rifiÃ©s (moins de faux positifs)
        continue-on-error: true
        # Passer Ã  false en production pour bloquer les PR avec secrets


