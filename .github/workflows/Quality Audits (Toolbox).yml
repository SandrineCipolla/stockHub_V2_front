name: Quality Audits (Toolbox).yml

# Objectif : tester les outils de la bo√Æte √† outils CI/CD
# R√©f√©rentiel RNCP : Ce2.2.4 (s√©curit√©), Ce2.3.5 (accessibilit√©), Ce2.3.3 (performance/SEO)


on:
  pull_request:
    branches: ["main"]
  push:
    branches: ["feature/**"]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  # JOB 1 : size-limit - Budget de performance bundle
  # Remplace bundlephobia (CLI non disponible) pour l'usage CI
  # R√©f√©rentiel : Ce2.3.3 (√©co-conception, performance)
  # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  bundle-size:
    name: üì¶ Bundle Size Budget
    runs-on: ubuntu-latest

    steps:
      - name: üì• Checkout
        uses: actions/checkout@v4

      - name: üîß Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: üì¶ Install dependencies
        run: |
          npm ci
          if ! npm list @rollup/rollup-linux-x64-gnu > /dev/null 2>&1; then
            echo "‚ö†Ô∏è Rollup optional dependency missing, reinstalling..."
            rm -rf node_modules package-lock.json
            npm install --include=optional
          fi

      - name: üèóÔ∏è Build
        run: npm run build
        env:
          ROLLUP_SKIP_NODE_NATIVE: "true"
          VITE_API_SERVER_URL: "https://mock-api.example.com"
          VITE_REDIRECT_URI: "https://mock.example.com"
          VITE_API_V1: "/v1"
          VITE_API_V2: "/v2"

      - name: üìä Analyse bundle avec vite-bundle-visualizer
        run: |
          echo "=== Taille du bundle produit ==="
          du -sh dist/assets/*.js 2>/dev/null | sort -h || echo "Pas de JS dans dist/assets"
          du -sh dist/assets/*.css 2>/dev/null | sort -h || echo "Pas de CSS dans dist/assets"
          echo ""
          echo "=== Total dist/ ==="
          du -sh dist/
          echo ""
          echo "=== Objectif : < 600kb gzipped (planning_ameliorations_v2.md) ==="
          # Calcul taille gzipp√©e approximative
          total_gz=$(find dist -name "*.js" -o -name "*.css" | xargs gzip -c | wc -c)
          echo "Taille gzipp√©e estim√©e : $(echo $total_gz | awk '{printf "%.0f KB", $1/1024}')"
        continue-on-error: true

      - name: üîç Vite bundle visualizer (rapport HTML)
        run: |
          mkdir -p bundle-report
           # Capturer stdout pour extraire "Generated at /tmp/..."
           OUTPUT=$(npx vite-bundle-visualizer --open false 2>&1)
          echo "$OUTPUT"
          STATS_PATH=$(echo "$OUTPUT" | grep "Generated at" | awk '{print $NF}')
          echo "Chemin d√©tect√© : $STATS_PATH"
          if [ -n "$STATS_PATH" ] && [ -f "$STATS_PATH" ]; then
            cp "$STATS_PATH" bundle-report/stats.html
            echo "‚úÖ stats.html copi√©"
          else
             echo "‚ö†Ô∏è Copie √©chou√©e"
          fi
        continue-on-error: true

      - name: üì§ Upload bundle report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: bundle-size-report
          path: bundle-report/stats.html
          retention-days: 7

  # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  # JOB 2 : Lighthouse CI (Performance + Accessibilit√© + SEO + Best Practices)
  # R√©f√©rentiel : Ce2.3.3 (performance), Ce2.3.5 (accessibilit√©)
  # Couvre aussi le "Lighthouse SEO" mentionn√© dans la bo√Æte √† outils
  # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  lighthouse-ci:
    name: üè† Lighthouse CI (Perf + A11y + SEO)
    runs-on: ubuntu-latest

    steps:
      - name: üì• Checkout
        uses: actions/checkout@v4

      - name: üîß Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: üì¶ Install dependencies
        run: |
          npm ci
          if ! npm list @rollup/rollup-linux-x64-gnu > /dev/null 2>&1; then
            echo "‚ö†Ô∏è Rollup optional dependency missing, reinstalling..."
            rm -rf node_modules package-lock.json
            npm install --include=optional
          fi

      - name: üèóÔ∏è Build
        run: npm run build
        env:
          ROLLUP_SKIP_NODE_NATIVE: "true"
          VITE_API_SERVER_URL: "https://mock-api.example.com"
          VITE_REDIRECT_URI: "https://mock.example.com"
          VITE_API_V1: "/v1"
          VITE_API_V2: "/v2"

      - name: üîß Install LHCI
        run: npm install -g @lhci/cli

      - name: üöÄ Serve dist locally
        run: |
          npm install -g serve
          serve -s dist -p 3000 &
          # Attendre que le serveur soit pr√™t
          npx wait-on http://localhost:3000 --timeout 30000

      - name: üè† Run Lighthouse CI
        run: |
          lhci autorun \
            --collect.url=http://localhost:3000 \
            --collect.numberOfRuns=1 \
            --assert.assertions.categories:performance=warn \
            --assert.assertions.categories:accessibility=warn \
            --assert.assertions.categories:seo=warn \
            --assert.assertions.categories:best-practices=warn \
            --upload.target=temporary-public-storage
        # Note : --upload.target=temporary-public-storage envoie les r√©sultats
        # sur le stockage public temporaire LHCI (gratuit, 7 jours de r√©tention)
        # Alternative : utiliser un lhci-server auto-h√©berg√© pour historique
        continue-on-error: true
        # continue-on-error: true car c'est une phase d'exp√©rimentation
        # Passer √† false quand les seuils sont stabilis√©s

    # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    # JOB 3 : axe-core - Tests accessibilit√© automatis√©s
    # R√©f√©rentiel : Ce2.3.5
    # Rappel bo√Æte √† outils : valide ~25-30% d'un audit, reste = analyse humaine
    # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    axe-accessibility:
      name: ‚ôø axe-core Accessibility
      runs-on: ubuntu-latest

      steps:
        - name: üì• Checkout
          uses: actions/checkout@v4

        - name: üîß Setup Node.js
          uses: actions/setup-node@v4
          with:
            node-version: 20
            cache: 'npm'

        - name: üì¶ Install dependencies
          run: |
            npm ci
            if ! npm list @rollup/rollup-linux-x64-gnu > /dev/null 2>&1; then
              echo "‚ö†Ô∏è Rollup optional dependency missing, reinstalling..."
              rm -rf node_modules package-lock.json
              npm install --include=optional
            fi

        - name: üèóÔ∏è Build
          run: npm run build
          env:
            ROLLUP_SKIP_NODE_NATIVE: "true"
            VITE_API_SERVER_URL: "https://mock-api.example.com"
            VITE_REDIRECT_URI: "https://mock.example.com"
            VITE_API_V1: "/v1"
            VITE_API_V2: "/v2"

        - name: üîß Install axe-core CLI + serveur local
          run: |
            npm install -g @axe-core/cli serve
            npm install -g wait-on

        - name: üöÄ Serve + Run axe
          run: |
            serve -s dist -p 3001 &
            npx wait-on http://localhost:3001 --timeout 30000
            echo "Lancement audit axe-core..."
            axe http://localhost:3001 --exit || true
            # --exit : code de sortie != 0 si violations trouv√©es
            # || true : ne pas faire √©chouer le workflow en phase exp√©
          # Pour activer le blocage strict plus tard, retirer "|| true"
          continue-on-error: true


