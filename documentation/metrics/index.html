<!DOCTYPE html>
<html class="dark" lang="fr">
<head>
    <meta charset="UTF-8" />
    <title>üìä StockHub V2 - Dashboard Qualit√© (Dynamique)</title>

    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root {
            --sh-purple-500: #8b5cf6;
            --sh-purple-400: #a78bfa;
            --sh-purple-300: #c4b5fd;
            --sh-dark-bg: #1a1a3e;
            --sh-card-bg: #0f0f23;
            --sh-border: rgba(255, 255, 255, 0.15);
        }
        body {
            background: var(--sh-dark-bg);
            color: white;
            font-family: 'Inter', sans-serif;
        }
        .card {
            background: var(--sh-card-bg);
            border: 1px solid var(--sh-border);
            border-radius: 1rem;
            padding: 1.5rem;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
        }
        .section-title {
            font-size: 1.6rem;
            color: var(--sh-purple-400);
            margin-bottom: 1rem;
            font-weight: 600;
        }
        /* Ajout styles tooltips coverage */
        .tooltip-wrapper { position: relative; display:inline-block; }
        .tooltip-box { position:absolute; left:0; top:110%; z-index:20; background:#1f1f2e; color:#fff; padding:.5rem .75rem; font-size:.65rem; line-height:1rem; border:1px solid rgba(255,255,255,.1); width:200px; border-radius:.5rem; box-shadow:0 4px 12px rgba(0,0,0,.4); opacity:0; transform:translateY(-4px); pointer-events:none; transition:.15s ease; }
        .tooltip-wrapper:focus .tooltip-box,
        .tooltip-wrapper:hover .tooltip-box { opacity:1; transform:translateY(0); }
    </style>
</head>

<body class="min-h-screen px-6 py-6">

<!-- HEADER -->
<header class="mb-10">
    <h1 class="text-4xl font-bold text-[var(--sh-purple-400)]">
        üìä StockHub V2 ‚Äî Tableau de bord Qualit√©
    </h1>

    <p class="opacity-80 mt-1">
        G√©n√©r√© automatiquement ‚Äî derni√®re mise √† jour :
        <span id="generated-date"></span>
    </p>

    <a class="mt-4 inline-block text-[var(--sh-purple-300)] underline hover:text-[var(--sh-purple-400)]"
       href="https://sandrinecipolla.github.io/stockHub_V2_front/metrics/"
       target="_blank">
        üåç Voir la version publique GitHub Pages
    </a>
</header>

<script>
    document.getElementById("generated-date").textContent =
        new Date().toLocaleString("fr-FR");
</script>

<!-- GRID -->
<div class="grid grid-cols-1 md:grid-cols-2 gap-10">
    <section class="card"><h2 class="section-title">üî¶ Lighthouse</h2><canvas id="chart-lighthouse"></canvas></section>
    <section class="card"><h2 class="section-title">‚ö†Ô∏è WCAG Risk Levels</h2><canvas id="chart-wcag"></canvas></section>
    <section class="card"><h2 class="section-title">üëÅ Daltonisme</h2><canvas id="chart-daltonisme"></canvas></section>
    <section class="card"><h2 class="section-title">‚ö° Performance FPS</h2><p id="fps-result"></p></section>
    <section class="card"><h2 class="section-title">‚ôø Accessibilit√© ‚Äî Reduced Motion</h2><p id="a11y-result"></p></section>
    <section class="card"><h2 class="section-title">üìä Scalabilit√© ‚Äî Datasets</h2><p id="dataset-result"></p></section>
</div>

<!-- COVERAGE -->
<section class="mt-14 card" id="coverage-section">
    <h2 class="section-title">üìà Coverage des tests</h2>
    <div class="space-y-4 text-sm" id="coverage-content">
        <p class="opacity-70">Chargement du r√©sum√© de coverage‚Ä¶</p>
    </div>
</section>

<!-- AUDIT COMPLET RNCP -->
<section class="mt-14 card" id="audit-rncp">
    <h2 class="section-title">üìö Audit Complet RNCP ‚Äî Synth√®se</h2>
    <div class="text-md opacity-90 mb-4" id="audit-rncp-content">
        Chargement des donn√©es RNCP...
    </div>

    <button class="px-4 py-2 bg-[var(--sh-purple-500)] rounded-lg hover:bg-[var(--sh-purple-400)] transition"
            onclick="toggleAuditDetails()">
        üìÇ Voir / Masquer les d√©tails
    </button>

    <div class="hidden mt-6 space-y-6" id="audit-details">
        <div class="border-t border-white/10 pt-4">
            <h3 class="text-xl text-[var(--sh-purple-300)] font-semibold">üìä Performance</h3>
            <div id="audit-performance"></div>
        </div>
        <div class="border-t border-white/10 pt-4">
            <h3 class="text-xl text-[var(--sh-purple-300)] font-semibold">‚ôø Accessibilit√©</h3>
            <div id="audit-accessibility"></div>
        </div>
        <div class="border-t border-white/10 pt-4">
            <h3 class="text-xl text-[var(--sh-purple-300)] font-semibold">üå± √âco-conception</h3>
            <div id="audit-eco"></div>
        </div>
        <div class="border-t border-white/10 pt-4">
            <h3 class="text-xl text-[var(--sh-purple-300)] font-semibold">üíé Qualit√© du code</h3>
            <div id="audit-quality"></div>
        </div>
    </div>
</section>

<!-- FOOTER -->
<footer class="mt-20 pb-10 text-center opacity-70">
    StockHub V2 ¬© 2025 ‚Äî Dashboard Qualit√© g√©n√©r√© automatiquement.
</footer>

<!-- SCRIPT DYNAMIQUE -->
<script>
    const jsonBasePaths = [
        "./data/", // local
        "https://sandrinecipolla.github.io/stockHub_V2_front/data/"
    ];

    async function findLatestJSON(prefix) {
        // D√©tecter si on est en local ou sur GitHub Pages
        const isLocal = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';

        // Liste statique des fichiers disponibles (fallback si le listage de dossier ne fonctionne pas)
        const staticFileList = [
            'lighthouse-1763634146672.json',
            'risk-levels-audit-1763634259430.json',
            'daltonisme-1763648733792.json',
            'fps-1763634225042.json',
            'a11y-1763635763804.json',
            'datasets-1763634247354.json',
            'audit-complet-1763634146592.json'
        ];

        // Mapping des pr√©fixes aux patterns de fichiers
        const prefixMapping = {
            'lighthouse': /^lighthouse-\d+\.json$/,
            'risk-levels': /^risk-levels-audit-\d+\.json$/,
            'daltonisme': /^daltonisme-\d+\.json$/,
            'fps': /^fps-\d+\.json$/,
            'a11y': /^a11y-\d+\.json$/,
            'datasets': /^datasets-\d+\.json$/,
            'audit-complet': /^audit-complet-\d+\.json$/
        };

        const pattern = prefixMapping[prefix];
        if (!pattern) {
            console.log(`Pattern non trouv√© pour le pr√©fixe: ${prefix}`);
            return null;
        }

        try {
            // Essayer d'abord de lister dynamiquement le dossier data
            const resp = await fetch("./data/");
            if (resp.ok) {
                const text = await resp.text();
                const matches = [...text.matchAll(/href="([^"]+\.json)"/g)]
                    .map(m => m[1])
                    .filter(name => pattern.test(name));
                if (matches.length > 0) {
                    matches.sort().reverse(); // Le plus r√©cent en premier (timestamp descendant)
                    console.log(`Fichier trouv√© pour ${prefix}: ${matches[0]}`);
                    return "./data/" + matches[0];
                }
            }
        } catch (e) {
            console.log(`Erreur lors du listage dynamique pour ${prefix}:`, e);
        }

        // Fallback : utiliser la liste statique
        const staticMatches = staticFileList.filter(name => pattern.test(name));
        if (staticMatches.length > 0) {
            staticMatches.sort().reverse();
            console.log(`Fichier statique trouv√© pour ${prefix}: ${staticMatches[0]}`);
            return "./data/" + staticMatches[0];
        }

        console.log(`Aucun fichier trouv√© pour le pr√©fixe: ${prefix}`);
        return null;
    }

    async function loadJSON(prefix) {
        const url = await findLatestJSON(prefix);
        if (!url) return null;
        const resp = await fetch(url);
        return resp.json();
    }

    async function loadAllData() {
        const lighthouse = await loadJSON('lighthouse');
        const wcag = await loadJSON('risk-levels');
        const daltonisme = await loadJSON('daltonisme');
        const fps = await loadJSON('fps');
        const a11y = await loadJSON('a11y');
        const datasets = await loadJSON('datasets');
        // NE PLUS charger audit complet ici (lazy load)
        renderCharts({ lighthouse, wcag, daltonisme, fps, a11y, datasets });
        // Placeholder audit synth√©tique l√©ger
        const auditLink = await findLatestJSON('audit-complet');
        const auditContent = document.getElementById('audit-rncp-content');
        auditContent.innerHTML = auditLink ? `<p class='text-sm'>Audit agr√©g√© disponible (<a class='underline text-[var(--sh-purple-300)]' href='${auditLink}' target='_blank' rel='noopener'>t√©l√©charger JSON</a>). Cliquez sur d√©tails pour charger.</p>` : `<p class='text-sm opacity-60'>Audit agr√©g√© non pr√©sent. G√©n√©rer via script.</p>`;
    }

    // Surcharge du bouton: charger audit au premier clic si pas d√©j√† charg√©
    let auditLoaded = false;
    async function toggleAuditDetails() {
        const details = document.getElementById('audit-details');
        details.classList.toggle('hidden');
        if (!auditLoaded && !details.classList.contains('hidden')) {
            const audit = await loadJSON('audit-complet');
            renderAudit(audit);
            auditLoaded = true;
        }
    }

    function renderCharts({ lighthouse, wcag, daltonisme, fps, a11y, datasets }) {
        // Lighthouse
        if (lighthouse?.scores) {
            new Chart(document.getElementById("chart-lighthouse"), {
                type: "radar",
                data: {
                    labels: ["Performance", "Accessibilit√©", "SEO", "Best Practices"],
                    datasets: [{
                        label: "Scores Lighthouse",
                        data: [
                            lighthouse.scores.performance || 0,
                            lighthouse.scores.accessibility || 0,
                            lighthouse.scores.seo || 0,
                            lighthouse.scores.bestPractices || 0
                        ],
                        borderColor: "#a78bfa",
                        backgroundColor: "rgba(167,139,250,0.3)"
                    }]
                },
                options: { scales: { r: { beginAtZero: true, max: 100 } } }
            });
        }

        // WCAG
        if (wcag) {
            new Chart(document.getElementById("chart-wcag"), {
                type: "bar",
                data: {
                    labels: ["Critique", "√âlev√©", "Moyen", "Faible"],
                    datasets: [{
                        data: [wcag.critique, wcag.eleve, wcag.moyen, wcag.faible],
                        backgroundColor: ["#ef4444", "#f97316", "#facc15", "#4ade80"]
                    }]
                }
            });
        }

        // Daltonisme
        if (daltonisme) {
            new Chart(document.getElementById("chart-daltonisme"), {
                type: "pie",
                data: {
                    labels: Object.keys(daltonisme),
                    datasets: [{
                        data: Object.values(daltonisme),
                        backgroundColor: ["#8b5cf6", "#a78bfa", "#c4b5fd", "#e9d5ff"]
                    }]
                }
            });
        }

        // Texte
        document.getElementById("fps-result").textContent =
            fps ? `FPS moyen : ${fps.avgOverall || 'N/A'} ${fps.allPassed ? '‚úÖ' : '‚ùå'}` : "En attente...";
        document.getElementById("a11y-result").textContent =
            a11y ? `${a11y.passed ? '‚úÖ Conforme' : '‚ùå Non conforme'}` : "En attente...";
        document.getElementById("dataset-result").textContent =
            datasets ? `D√©gradation : ${datasets.degradation || 'N/A'}%` : "En attente...";
    }

    function renderAudit(audit) {
        const el = document.getElementById('audit-rncp-content');
        const perfEl = document.getElementById('audit-performance');
        const accEl = document.getElementById('audit-accessibility');
        const ecoEl = document.getElementById('audit-eco');
        const qualityEl = document.getElementById('audit-quality');

        if (!audit) { el.innerHTML += '<p class="mt-2 text-yellow-400 text-xs">Impossible de charger audit-complet.</p>'; return; }
        el.innerHTML += `<p class='mt-2 text-xs opacity-50'>Charg√©: ${new Date(audit.timestamp).toLocaleString('fr-FR')}</p>`;

        // Performance
        perfEl.innerHTML = `<ul class='text-sm space-y-1'>${[
            audit.lighthouse?.scores?.performance!=null?`<li>Perf Lighthouse: <strong>${audit.lighthouse.scores.performance}%</strong></li>`:null,
            audit.fps?.avgOverall!=null?`<li>FPS moyen: <strong>${audit.fps.avgOverall}</strong> ${audit.fps.allPassed?'‚úÖ':'‚ö†Ô∏è'}</li>`:null,
            audit.datasets?.degradation!=null?`<li>D√©gradation datasets: <strong>${audit.datasets.degradation}%</strong></li>`:null
        ].filter(Boolean).join('')}</ul>`;

        // Accessibilit√©
        accEl.innerHTML = `<ul class='text-sm space-y-1'>${[
            audit.lighthouse?.scores?.accessibility!=null?`<li>Accessibilit√© Lighthouse: <strong>${audit.lighthouse.scores.accessibility}%</strong></li>`:null,
            audit.a11y?`<li>Reduced Motion: ${audit.a11y.passed?'‚úÖ Conforme':'‚ùå Non conforme'}</li>`:null,
            audit.daltonisme?`<li>Daltonisme: ${Object.entries(audit.daltonisme).map(([k,v])=>`${k}:${v}`).join(', ')}</li>`:null,
            audit.riskLevels?`<li>WCAG Risk Levels: Critique ${audit.riskLevels.critique}, √âlev√© ${audit.riskLevels.eleve}, Moyen ${audit.riskLevels.moyen}, Faible ${audit.riskLevels.faible}</li>`:null
        ].filter(Boolean).join('')}</ul>`;

        // √âco
        ecoEl.innerHTML = audit.eco ? `<p class='text-sm'>√âco (indicateurs principaux): <code>${Object.keys(audit.eco).slice(0,5).join(', ')}</code></p>` : `<p class='text-xs opacity-60'>Absent</p>`;

        // Coverage
        qualityEl.innerHTML = audit.coverage && audit.coverage.statements!=null ? `<p class='text-sm'>Statements: <strong>${audit.coverage.statements}%</strong> | Fonctions: ${audit.coverage.functions??'N/A'}% | Branches: ${audit.coverage.branches??'N/A'}%</p>` : `<p class='text-xs opacity-60'>Couverture non disponible</p>`;
    }

    async function loadCoverage() {
        // Chargement et traitement des donn√©es de couverture - CORRIG√â pour utiliser le bon chemin
        const candidates = [
            './coverage/coverage-final.json', // Local - dossier metrics
            '../../../coverage/coverage-final.json', // Racine du projet depuis metrics
            '../../coverage/coverage-final.json', // Alternative
            'https://sandrinecipolla.github.io/stockHub_V2_front/coverage/coverage-final.json' // GitHub Pages (si publi√©)
        ];
        let data = null;
        let usedUrl = null;

        for (const url of candidates) {
            try {
                console.log(`Tentative de chargement: ${url}`);
                const r = await fetch(url);
                if (r.ok) {
                    data = await r.json();
                    usedUrl = url;
                    console.log(`Coverage charg√©e depuis: ${url}`);
                    break;
                } else {
                    console.log(`√âchec ${url}: ${r.status}`);
                }
            } catch (e) {
                console.log(`Erreur ${url}:`, e.message);
            }
        }

        const container = document.getElementById('coverage-content');
        if (!data) {
            container.innerHTML = `
                <p class="text-red-400">‚ùå Impossible de charger coverage-final.json</p>
                <p class="text-xs opacity-60 mt-2">Tentatives effectu√©es :</p>
                <ul class="text-xs opacity-60 mt-1">
                    ${candidates.map(url => `<li>‚Ä¢ ${url}</li>`).join('')}
                </ul>
                <p class="text-xs opacity-60 mt-2">Assurez-vous que les tests de couverture ont √©t√© ex√©cut√©s avec <code>npm run test:coverage</code></p>
            `;
            return;
        }

        const GROUP_RULES = [
            { id:'dashboard', label:'Dashboard', help:'Vue principale et widgets du tableau de bord', match:f=> /pages[\\\/]Dashboard|Dashboard/i.test(f) },
            { id:'analytics', label:'Analytics', help:'Pages et logique analytique', match:f=> /pages[\\\/]Analytics|analytics/i.test(f) },
            { id:'components', label:'Components UI', help:'Composants r√©utilisables (src/components)', match:f=> /components[\\\/]/.test(f) },
            { id:'hooks', label:'Hooks', help:'Hooks personnalis√©s (src/hooks)', match:f=> /hooks[\\\/]/.test(f) },
            { id:'utils', label:'Utils', help:'Fonctions utilitaires diverses', match:f=> /utils[\\\/]/.test(f) },
            { id:'contexts', label:'Contexts', help:'Gestion des contextes React (src/contexts)', match:f=> /contexts[\\\/]/.test(f) },
            { id:'data', label:'Data Layer', help:'Acc√®s et mod√®les de donn√©es (src/data)', match:f=> /data[\\\/]/.test(f) }
        ];

        let totalStatements=0, coveredStatements=0;
        const fileCoverages=[];
        for (const [fileName, fileObj] of Object.entries(data)) {
            if (!fileObj || !fileObj.s) continue;
            const sVals = Object.values(fileObj.s);
            const fileStatements = sVals.length;
            const fileCoveredStatements = sVals.filter(v=>v>0).length;
            totalStatements += fileStatements;
            coveredStatements += fileCoveredStatements;
            if (fileStatements>0) {
                fileCoverages.push({ raw:fileName, file: fileName.replace(/^.*src[\\\/]/,''), statements:fileStatements, covered:fileCoveredStatements });
            }
        }
        const pct=(c,t)=> t===0?0:(c/t*100);

        const groupMap = GROUP_RULES.map(g=>({ id:g.id, label:g.label, help:g.help, statements:0, covered:0 }));
        for (const fc of fileCoverages) {
            const match = GROUP_RULES.find(gr=> gr.match(fc.raw));
            if (match) {
                const target = groupMap.find(g=>g.id===match.id);
                target.statements += fc.statements;
                target.covered += fc.covered;
            }
        }
        const effectiveGroups = groupMap.filter(g=> g.statements>0).map(g=> ({...g, pct: pct(g.covered,g.statements)}));
        const sortedGroups = [...effectiveGroups].sort((a,b)=> a.pct - b.pct);
        const bestGroups = [...effectiveGroups].sort((a,b)=> b.pct - a.pct).slice(0,3);

        const withPctFiles = fileCoverages.map(f=> ({...f, pct: pct(f.covered,f.statements)}));
        const worst = withPctFiles.filter(f=> f.statements>=5).sort((a,b)=> a.pct - b.pct).slice(0,5);
        const best = withPctFiles.filter(f=> f.statements>=5).sort((a,b)=> b.pct - a.pct).slice(0,5);

        const colorFor = p => p>=85? 'text-green-400' : p>=70? 'text-yellow-400' : 'text-red-400';
        const bar = p => `<div class='h-2 w-full bg-white/10 rounded'><div class='h-2 rounded bg-[var(--sh-purple-500)]' style='width:${p.toFixed(1)}%'></div></div>`;
        const listBlock = (title, arr) => arr.length ? `<div class='mt-8'><h3 class='font-semibold mb-2 text-sm'>${title}</h3><ul class='space-y-1 text-xs'>${arr.map(f=> `<li class='flex justify-between'><span class='truncate max-w-[65%]' title='${f.file}'>${f.file}</span><span class='${colorFor(f.pct)}'>${f.pct.toFixed(1)}%</span></li>`).join('')}</ul></div>` : '';

        const groupBlock = effectiveGroups.length ? `
          <div class='mt-8'>
            <h3 class='font-semibold mb-2 text-sm'>Couverture par domaine fonctionnel</h3>
            <div class='space-y-3'>
              ${sortedGroups.map(g=>`
                <div>
                  <div class='flex justify-between mb-0.5'>
                    <span class='tooltip-wrapper' tabindex='0'>${g.label} <span class='tooltip-box'>${g.help}</span></span>
                    <span class='${colorFor(g.pct)} text-xs'>${g.pct.toFixed(1)}%</span>
                  </div>
                  ${bar(g.pct)}
                </div>
              `).join('')}
            </div>
            <div class='mt-4 text-xs opacity-60'>Top domaines bien couverts : ${bestGroups.map(g=> g.label + ' (' + g.pct.toFixed(0)+'%)').join(', ')}</div>
          </div>`
          : '<div class="mt-8 text-xs opacity-60">Aucun regroupement fonctionnel d√©tect√© (v√©rifiez vos dossiers).</div>';

        // === Ajout r√®gles fonctionnalit√©s utilisateur ===
        const FEATURE_RULES = [
          { id:'crud', label:'Gestion Stocks (CRUD)', help:'Cr√©ation, mise √† jour, filtrage des stocks (useStocks, Dashboard, config)', match:f=> /(hooks[\\\/]useStocks|pages[\\\/]Dashboard|stockConfig|stockData)/i.test(f) },
          { id:'prediction', label:'Pr√©dictions IA', help:'Simulation & composant pr√©diction (mlSimulation, StockPrediction, aiPredictions)', match:f=> /(utils[\\\/]mlSimulation|components[\\\/]ai[\\\/]StockPrediction|utils[\\\/]aiPredictions)/i.test(f) },
          { id:'alerts', label:'Alertes & Statuts', help:'Badges statut, calcul niveaux de risque, config', match:f=> /(StatusBadge|statusBadge|stockConfig|risk-levels|determineRiskLevel)/i.test(f) },
          { id:'preferences', label:'Pr√©f√©rences & Th√®me', help:'Gestion th√®me & pr√©f√©rences utilisateur', match:f=> /(contexts[\\\/]theme)/i.test(f) },
          { id:'dataLayer', label:'Couche Donn√©es', help:'Structures & acc√®s (src/data)', match:f=> /src[\\\/]data[\\\/]/i.test(f) },
          { id:'support', label:'Support g√©n√©rique', help:'Hooks/Utils techniques hors CRUD sp√©cifique', match:f=> /(src[\\\/]utils|src[\\\/]hooks)/i.test(f) }
        ];
        function aggregateByRules(rules, files) {
          const groups = rules.map(r=> ({ ...r, statements:0, covered:0, files:[] }));
          for (const fc of files) {
            const rule = rules.find(r=> r.match(fc.raw));
            if (rule) {
              const g = groups.find(gr=> gr.id===rule.id);
              g.statements += fc.statements;
              g.covered += fc.covered;
              g.files.push(fc);
            }
          }
          return groups.filter(g=> g.statements>0).map(g=> ({ ...g, pct: pct(g.covered,g.statements) }));
        }
        const featureGroups = aggregateByRules(FEATURE_RULES, fileCoverages);
        const sortedFeatureGroups = [...featureGroups].sort((a,b)=> a.pct - b.pct);
        const topFeatureGroups = [...featureGroups].sort((a,b)=> b.pct - a.pct).slice(0,3);
        const featureBlock = featureGroups.length ? `
          <div class='mt-10'>
            <h3 class='font-semibold mb-2 text-sm'>Couverture par fonctionnalit√© (vue utilisateur)</h3>
            <div class='space-y-3'>
              ${sortedFeatureGroups.map(g=> {
                const examples = g.files.sort((a,b)=> b.statements - a.statements).slice(0,2).map(f=> f.file).join(', ');
                return `<div>
                  <div class='flex justify-between mb-0.5'>
                    <span class='tooltip-wrapper' tabindex='0'>${g.label} <span class='tooltip-box'>${g.help}${examples?`<br/><em>Exemples: ${examples}</em>`:''}</span></span>
                    <span class='${colorFor(g.pct)} text-xs'>${g.pct.toFixed(1)}%</span>
                  </div>
                  ${bar(g.pct)}
                </div>`;
              }).join('')}
            </div>
            <div class='mt-4 text-xs opacity-60'>Fonctionnalit√©s mieux couvertes : ${topFeatureGroups.map(g=> g.label + ' (' + g.pct.toFixed(0)+'%)').join(', ')}</div>
          </div>` : `<div class='mt-10 text-xs opacity-60'>Pas de regroupement fonctionnel d√©tect√© (r√®gles non satisfaites).</div>`;

        const globalPct = pct(coveredStatements,totalStatements);
        container.innerHTML = `
          <div class='mb-4'>
            <p class='text-lg'>Couverture globale (instructions) : <span class='font-semibold ${colorFor(globalPct)}'>${globalPct.toFixed(1)}%</span></p>
            <p class='text-xs opacity-60'>Source: ${usedUrl}</p>
            <p class='text-xs opacity-60 flex gap-3'>
              <span><span class='inline-block w-2 h-2 rounded-full bg-green-400 align-middle'></span> ‚â•85% bon</span>
              <span><span class='inline-block w-2 h-2 rounded-full bg-yellow-400 align-middle'></span> 70‚Äì84% moyen</span>
              <span><span class='inline-block w-2 h-2 rounded-full bg-red-400 align-middle'></span> <70% faible</span>
            </p>
          </div>
          ${groupBlock}
          ${featureBlock}
          ${listBlock('Top qualit√© (meilleurs fichiers)', best)}
          ${listBlock('Priorit√©s d\'am√©lioration (faible couverture)', worst)}
          <p class='text-xs opacity-50 mt-4'>Source : coverage-final.json ‚Äì regroupements dossiers & fonctionnalit√©s heuristiques.</p>
        `;
    }
    // Appels
    loadCoverage();
    loadAllData();
</script>
</body>
</html>
