<!DOCTYPE html>
<html class="dark" lang="fr">
<head>
    <meta charset="UTF-8" />
    <title>üìä StockHub V2 - Dashboard Qualit√© (Dynamique)</title>

    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root {
            --sh-purple-500: #8b5cf6;
            --sh-purple-400: #a78bfa;
            --sh-purple-300: #c4b5fd;
            --sh-dark-bg: #1a1a3e;
            --sh-card-bg: #0f0f23;
            --sh-border: rgba(255, 255, 255, 0.15);
        }
        body {
            background: var(--sh-dark-bg);
            color: white;
            font-family: 'Inter', sans-serif;
        }
        .card {
            background: var(--sh-card-bg);
            border: 1px solid var(--sh-border);
            border-radius: 1rem;
            padding: 1.5rem;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
        }
        .section-title {
            font-size: 1.6rem;
            color: var(--sh-purple-400);
            margin-bottom: 1rem;
            font-weight: 600;
        }
        /* Ajout styles tooltips coverage */
        .tooltip-wrapper { position: relative; display:inline-block; }
        .tooltip-box { position:absolute; left:0; top:110%; z-index:20; background:#1f1f2e; color:#fff; padding:.5rem .75rem; font-size:.65rem; line-height:1rem; border:1px solid rgba(255,255,255,.1); width:200px; border-radius:.5rem; box-shadow:0 4px 12px rgba(0,0,0,.4); opacity:0; transform:translateY(-4px); pointer-events:none; transition:.15s ease; }
        .tooltip-wrapper:focus .tooltip-box,
        .tooltip-wrapper:hover .tooltip-box { opacity:1; transform:translateY(0); }

        /* Animations et effets visuels */
        .metric-card {
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        .metric-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 30px rgba(139, 92, 246, 0.3);
        }
        .metric-card::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; height: 3px;
            background: linear-gradient(90deg, var(--sh-purple-500), var(--sh-purple-300));
        }
        .pulse-dot {
            width: 8px; height: 8px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.2); }
        }
        .progress-ring {
            transform: rotate(-90deg);
            transition: stroke-dasharray 0.8s ease-in-out;
        }
        .fade-in { animation: fadeIn 0.8s ease-out; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .chart-container { position: relative; height: 200px; }
        .chart-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%); /* Retour au centrage original */
            text-align: center;
            z-index: 10;
            pointer-events: none;
            background: rgba(15, 15, 35, 0.9);
            border-radius: 50%;
            width: 80px;
            height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 4px 15px rgba(139, 92, 246, 0.3);
        }

        .chart-overlay-text {
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.8);
        }

        /* Nouveaux styles pour les cercles de score Lighthouse */
        .lighthouse-container {
            min-height: 400px;
            padding: 1.5rem;
        }

        .score-circle {
            position: relative;
            width: 100px;
            height: 100px;
            margin: 0 auto;
        }

        .score-circle-large {
            width: 140px;
            height: 140px;
        }

        .score-circle svg {
            width: 100%;
            height: 100%;
            transform: rotate(-90deg);
        }

        .score-circle-progress {
            transition: stroke-dasharray 1.5s ease-in-out;
            filter: drop-shadow(0 0 8px currentColor);
            stroke-dasharray: 0 282.6; /* Valeur par d√©faut, sera mise √† jour par JS */
        }

        .score-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            font-weight: bold;
        }

        /* Classes utilitaires pour les couleurs de score */
        .text-score-excellent { color: #10b981; }
        .text-score-good { color: #f59e0b; }
        .text-score-poor { color: #ef4444; }

        /* Classes pour les badges de notes */
        .badge-grade-a { background: linear-gradient(135deg, #10b981, #059669); color: white; }
        .badge-grade-b { background: linear-gradient(135deg, #10b981, #f59e0b); color: white; }
        .badge-grade-c { background: linear-gradient(135deg, #f59e0b, #d97706); color: white; }
        .badge-grade-d { background: linear-gradient(135deg, #f59e0b, #ef4444); color: white; }
        .badge-grade-f { background: linear-gradient(135deg, #ef4444, #dc2626); color: white; }

        /* Nouveaux styles pour les onglets de daltonisme */
        .daltonisme-tab, .wcag-tab {
            background-color: transparent;
            color: #9ca3af;
            border: none;
            cursor: pointer;
        }

        .daltonisme-tab.active, .wcag-tab.active {
            background-color: var(--sh-purple-500);
            color: white;
        }

        .daltonisme-tab:hover:not(.active), .wcag-tab:hover:not(.active) {
            background-color: rgba(255, 255, 255, 0.1);
            color: #d1d5db;
        }

        .daltonisme-panel, .wcag-panel {
            display: none;
        }

        .daltonisme-panel.active, .wcag-panel.active {
            display: block;
        }

        /* Styles pour les visualisations de couleurs */
        .color-preview {
            width: 24px;
            height: 24px;
            border-radius: 6px;
            border: 2px solid rgba(255, 255, 255, 0.2);
            display: inline-block;
            position: relative;
            cursor: help;
        }

        .color-preview.simulated::after {
            content: '';
            position: absolute;
            top: -2px;
            right: -2px;
            width: 8px;
            height: 8px;
            background: #f59e0b;
            border-radius: 50%;
            border: 1px solid #1f2937;
        }

        /* Styles pour les grilles de comparaison */
        .color-comparison-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            align-items: center;
        }

        .daltonism-type-card {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.1), rgba(59, 130, 246, 0.05));
            border: 1px solid rgba(139, 92, 246, 0.2);
            border-radius: 12px;
            padding: 1rem;
            transition: all 0.3s ease;
        }

        .daltonism-type-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(139, 92, 246, 0.2);
        }

        /* Styles pour les m√©triques Delta E */
        .delta-e-indicator {
            font-family: monospace;
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-weight: bold;
        }

        .delta-e-good {
            background: rgba(16, 185, 129, 0.2);
            color: #10b981;
            border: 1px solid rgba(16, 185, 129, 0.3);
        }

        .delta-e-warning {
            background: rgba(245, 158, 11, 0.2);
            color: #f59e0b;
            border: 1px solid rgba(245, 158, 11, 0.3);
        }

        .delta-e-critical {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        /* Animations pour l'√©tat de chargement */
        .loading-shimmer {
            background: linear-gradient(90deg, #374151 25%, #4b5563 50%, #374151 75%);
            background-size: 200% 100%;
            animation: shimmer 2s infinite;
        }

        @keyframes shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }

        /* Styles responsifs pour les onglets */
        @media (max-width: 768px) {
            .daltonisme-tab {
                padding: 0.5rem 0.75rem;
                font-size: 0.75rem;
            }

            .color-comparison-grid {
                grid-template-columns: 1fr;
            }

            #daltonisme-content .grid {
                grid-template-columns: 1fr !important;
            }
        }
    </style>
</head>

<body class="min-h-screen px-6 py-6">

<!-- HEADER -->
<header class="mb-10">
    <h1 class="text-4xl font-bold text-[var(--sh-purple-400)]">
        üìä StockHub V2 ‚Äî Tableau de bord Qualit√©
    </h1>

    <p class="opacity-80 mt-1">
        G√©n√©r√© automatiquement ‚Äî derni√®re mise √† jour :
        <span id="generated-date"></span>
    </p>

    <!-- Lien contextuel selon l'environnement -->
    <a class="mt-4 inline-block text-[var(--sh-purple-300)] underline hover:text-[var(--sh-purple-400)]" href="#"
       id="context-link"
       style="display: none;"
       target="_blank">
    </a>
</header>

<script>
    // Date de g√©n√©ration
    document.getElementById("generated-date").textContent = new Date().toLocaleString("fr-FR");

    // Lien contextuel
    const contextLink = document.getElementById("context-link");
    const isLocal = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
    const isGitHubPages = window.location.hostname.includes('github.io');

    if (isLocal) {
        // En local : lien vers GitHub Pages
        contextLink.href = "https://sandrinecipolla.github.io/stockHub_V2_front/documentation/metrics/";
        contextLink.textContent = "üåç Voir la version publique GitHub Pages";
        contextLink.style.display = "inline-block";
    } else if (isGitHubPages) {
        // Sur GitHub Pages : lien vers le repo
        contextLink.href = "https://github.com/SandrineCipolla/stockHub_V2_front";
        contextLink.textContent = "üìÇ Voir le code source sur GitHub";
        contextLink.style.display = "inline-block";
    }
    // Sur Vercel ou autre : pas de lien
</script>

<!-- GRID -->
<div class="grid grid-cols-1 md:grid-cols-2 gap-10">
    <section class="card metric-card fade-in">
        <h2 class="section-title">üî¶ Lighthouse</h2>
        <div class="lighthouse-container" id="lighthouse-content">
            <div class="flex items-center justify-center h-32 text-gray-400">
                <p>‚è≥ Chargement des scores Lighthouse...</p>
            </div>
        </div>
    </section>
    <section class="card metric-card fade-in">
        <h2 class="section-title flex items-center gap-3">
            ‚ö†Ô∏è WCAG Risk Levels
            <div class="text-xs px-3 py-1 rounded-full bg-gray-700 text-gray-300" id="wcag-status-badge">
                ‚è≥ Chargement...
            </div>
        </h2>
        <p class="text-sm text-gray-400 mb-6">
            Analyse des contrastes de couleurs selon les niveaux de risque (critical, high, medium, low)
        </p>

        <!-- Navigation par onglets WCAG -->
        <div class="mb-6">
            <div class="flex flex-wrap gap-1 bg-gray-800/50 p-1 rounded-lg">
                <button class="wcag-tab active px-4 py-2 text-sm font-medium rounded-md transition-all" data-tab="overview">
                    üìä Vue d'ensemble
                </button>
                <button class="wcag-tab px-4 py-2 text-sm font-medium rounded-md transition-all" data-tab="critical">
                    üî¥ Critique
                </button>
                <button class="wcag-tab px-4 py-2 text-sm font-medium rounded-md transition-all" data-tab="high">
                    üü† √âlev√©
                </button>
                <button class="wcag-tab px-4 py-2 text-sm font-medium rounded-md transition-all" data-tab="medium">
                    üü° Moyen
                </button>
                <button class="wcag-tab px-4 py-2 text-sm font-medium rounded-md transition-all" data-tab="low">
                    üü¢ Faible
                </button>
                <button class="wcag-tab px-4 py-2 text-sm font-medium rounded-md transition-all" data-tab="solutions">
                    üîß Solutions
                </button>
            </div>
        </div>

        <!-- Contenu des onglets WCAG -->
        <div id="wcag-content">
            <!-- Vue d'ensemble -->
            <div class="wcag-panel active" data-panel="overview">
                <div class="chart-container">
                    <canvas id="chart-wcag"></canvas>
                </div>
            </div>

            <!-- Onglet Critique -->
            <div class="wcag-panel" data-panel="critical">
                <div id="critical-problems">
                    <!-- Sera rempli dynamiquement -->
                </div>
            </div>

            <!-- Onglet √âlev√© -->
            <div class="wcag-panel" data-panel="high">
                <div id="high-problems">
                    <!-- Sera rempli dynamiquement -->
                </div>
            </div>

            <!-- Onglet Moyen -->
            <div class="wcag-panel" data-panel="medium">
                <div id="medium-problems">
                    <!-- Sera rempli dynamiquement -->
                </div>
            </div>

            <!-- Onglet Faible -->
            <div class="wcag-panel" data-panel="low">
                <div id="low-problems">
                    <!-- Sera rempli dynamiquement -->
                </div>
            </div>

            <!-- Onglet Solutions -->
            <div class="wcag-panel" data-panel="solutions">
                <div id="wcag-solutions">
                    <!-- Sera rempli dynamiquement -->
                </div>
            </div>
        </div>
    </section>
    <section class="card metric-card fade-in" id="daltonisme-section">
        <h2 class="section-title flex items-center gap-3">
            üëÅ Tests de Daltonisme & Accessibilit√© Visuelle
            <div class="text-xs px-3 py-1 rounded-full bg-gray-700 text-gray-300" id="daltonisme-status-badge">
                ‚è≥ Chargement...
            </div>
        </h2>

        <!-- Navigation par onglets -->
        <div class="mb-6">
            <div class="flex flex-wrap gap-1 bg-gray-800/50 p-1 rounded-lg">
                <button class="daltonisme-tab active px-4 py-2 text-sm font-medium rounded-md transition-all" data-tab="overview">
                    üìä Vue d'ensemble
                </button>
                <button class="daltonisme-tab px-4 py-2 text-sm font-medium rounded-md transition-all" data-tab="contrast">
                    üé® Contraste WCAG
                </button>
                <button class="daltonisme-tab px-4 py-2 text-sm font-medium rounded-md transition-all" data-tab="simulation">
                    üëÅ Simulation
                </button>
                <button class="daltonisme-tab px-4 py-2 text-sm font-medium rounded-md transition-all" data-tab="difference">
                    üîç Diff√©rentiabilit√©
                </button>
            </div>
        </div>

        <!-- Contenu des onglets -->
        <div id="daltonisme-content">
            <!-- Vue d'ensemble -->
            <div class="daltonisme-panel active" data-panel="overview">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Graphique principal -->
                    <div class="chart-container">
                        <canvas id="chart-daltonisme"></canvas>
                    </div>

                    <!-- M√©triques cl√©s -->
                    <div class="space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div class="p-4 bg-gradient-to-br from-blue-500/10 to-purple-500/10 border border-blue-500/20 rounded-lg">
                                <div class="text-2xl font-bold text-blue-400" id="contrast-score">-</div>
                                <div class="text-xs text-gray-400">Tests contraste</div>
                            </div>
                            <div class="p-4 bg-gradient-to-br from-green-500/10 to-emerald-500/10 border border-green-500/20 rounded-lg">
                                <div class="text-2xl font-bold text-green-400" id="daltonism-score">-</div>
                                <div class="text-xs text-gray-400">Diff√©rentiabilit√©</div>
                            </div>
                        </div>

                        <div class="p-4 bg-gray-800/30 rounded-lg" id="status-colors-preview">
                            <div class="text-sm font-medium text-gray-300 mb-3">Couleurs de statut StockHub</div>
                            <div class="flex flex-wrap gap-2" id="color-status-grid">
                                <!-- Sera rempli dynamiquement -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- R√©sum√© global -->
                <div class="mt-6 p-4 bg-gray-800/30 rounded-lg" id="global-summary">
                    <!-- Sera rempli dynamiquement -->
                </div>
            </div>

            <!-- Tests de contraste -->
            <div class="daltonisme-panel" data-panel="contrast">
                <div class="grid grid-cols-1 xl:grid-cols-2 gap-6">
                    <div>
                        <h3 class="text-lg font-semibold text-gray-200 mb-4 flex items-center gap-2">
                            <span>&#127912; Tests de Contraste WCAG 2.1</span>
                            <span class="text-xs px-2 py-1 bg-blue-500/20 text-blue-300 rounded">AA/AAA</span>
                        </h3>
                        <div class="space-y-3" id="contrast-tests-grid">
                            <!-- Sera rempli dynamiquement -->
                        </div>
                    </div>

                    <div>
                        <h3 class="text-lg font-semibold text-gray-200 mb-4"><span>üìã Crit√®res WCAG</span></h3>
                        <div class="space-y-3 text-sm">
                            <div class="p-3 bg-green-500/10 border border-green-500/20 rounded-lg">
                                <div class="font-medium text-green-300">Level AAA (‚â• 7:1)</div>
                                <div class="text-green-200 text-xs">Contraste excellent - Texte normal</div>
                            </div>
                            <div class="p-3 bg-yellow-500/10 border border-yellow-500/20 rounded-lg">
                                <div class="font-medium text-yellow-300">Level AA (‚â• 4.5:1)</div>
                                <div class="text-yellow-200 text-xs">Contraste bon - Standard requis</div>
                            </div>
                            <div class="p-3 bg-blue-500/10 border border-blue-500/20 rounded-lg">
                                <div class="font-medium text-blue-300">UI Components (‚â• 3:1)</div>
                                <div class="text-blue-200 text-xs">Contraste minimal - √âl√©ments d'interface</div>
                            </div>
                            <div class="p-3 bg-red-500/10 border border-red-500/20 rounded-lg">
                                <div class="font-medium text-red-300">FAIL (&lt; 3:1)</div>
                                <div class="text-red-200 text-xs">Contraste insuffisant - √Ä corriger</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Simulation des types de daltonisme -->
            <div class="daltonisme-panel" data-panel="simulation">
                <h3 class="text-lg font-semibold text-gray-200 mb-4 flex items-center gap-2">
                    <span>Simulation des Types de Daltonisme</span>
                    <span class="text-xs px-2 py-1 bg-purple-500/20 text-purple-300 rounded">4 types test√©s</span>
                </h3>

                <div class="grid grid-cols-1 xl:grid-cols-2 gap-6" id="simulation-grid">
                    <!-- Sera rempli dynamiquement avec chaque type de daltonisme -->
                </div>
            </div>

            <!-- Tests de diff√©rentiabilit√© -->
            <div class="daltonisme-panel" data-panel="difference">
                <h3 class="text-lg font-semibold text-gray-200 mb-4 flex items-center gap-2">
                    <span>&#128269; Analyse de Diff√©rentiabilit√© des Couleurs</span>
                    <span class="text-xs px-2 py-1 bg-orange-500/20 text-orange-300 rounded">Delta E</span>
                </h3>

                <div class="space-y-6" id="difference-analysis">
                    <!-- Sera rempli dynamiquement -->
                </div>
            </div>
        </div>
    </section>
    <section class="card metric-card fade-in">
        <h2 class="section-title">‚ö° Performance FPS</h2>
        <p class="text-sm text-gray-400 mb-4">
            Mesure des performances d'animation et de rendu (objectif : 60 FPS stable)
        </p>
        <div id="fps-result"></div>
    </section>

    <section class="card metric-card fade-in">
        <h2 class="section-title">‚ôø Accessibilit√© ‚Äî Reduced Motion</h2>
        <p class="text-sm text-gray-400 mb-4">
            Respect de la pr√©f√©rence "prefers-reduced-motion" pour les utilisateurs sensibles au mouvement
        </p>
        <div id="a11y-result"></div>
    </section>

    <section class="card metric-card fade-in">
        <h2 class="section-title">üìä Scalabilit√© ‚Äî Datasets</h2>
        <p class="text-sm text-gray-400 mb-4">
            Test de performance avec diff√©rentes tailles de jeux de donn√©es (de 10 √† 10 000 items)
        </p>
        <div id="dataset-result"></div>
    </section>
</div>

<!-- COVERAGE -->
<section class="mt-14 card" id="coverage-section">
    <h2 class="section-title">üìà Coverage des tests</h2>
    <p class="text-sm text-gray-400 mb-6">
        Couverture de code par les tests unitaires (Vitest) - Analyse d√©taill√©e par fonctionnalit√©
    </p>
    <div class="space-y-4 text-sm" id="coverage-content">
        <p class="opacity-70">‚è≥ Chargement du r√©sum√© de coverage‚Ä¶</p>
    </div>
</section>

<!-- AUDIT COMPLET RNCP -->
<section class="mt-14 card" id="audit-rncp">
    <h2 class="section-title">üìö Audit Complet RNCP ‚Äî Synth√®se</h2>
    <p class="text-sm text-gray-400 mb-6">
        Agr√©gation de tous les audits (Performance, Accessibilit√©, √âco-conception, Qualit√©) pour d√©monstration RNCP 2027
    </p>
    <div class="text-md opacity-90 mb-4" id="audit-rncp-content">
        ‚è≥ Chargement des donn√©es RNCP...
    </div>

    <button class="px-4 py-2 bg-[var(--sh-purple-500)] rounded-lg hover:bg-[var(--sh-purple-400)] transition"
            onclick="toggleAuditDetails()">
        üìÇ Voir / Masquer les d√©tails
    </button>

    <div class="hidden mt-6 space-y-6" id="audit-details">
        <div class="border-t border-white/10 pt-4">
            <h3 class="text-xl text-[var(--sh-purple-300)] font-semibold"><span>üìä Performance</span></h3>
            <div id="audit-performance"></div>
        </div>
        <div class="border-t border-white/10 pt-4">
            <h3 class="text-xl text-[var(--sh-purple-300)] font-semibold"><span>‚ôø Accessibilit√©</span></h3>
            <div id="audit-accessibility"></div>
        </div>
        <div class="border-t border-white/10 pt-4">
            <h3 class="text-xl text-[var(--sh-purple-300)] font-semibold"><span>üå± √âco-conception</span></h3>
            <div id="audit-eco"></div>
        </div>
        <div class="border-t border-white/10 pt-4">
            <h3 class="text-xl text-[var(--sh-purple-300)] font-semibold"><span>üíé Qualit√© du code</span></h3>
            <div id="audit-quality"></div>
        </div>
    </div>
</section>

<!-- FOOTER -->
<footer class="mt-20 pb-10 text-center opacity-70">
    StockHub V2 ¬© 2025 ‚Äî Dashboard Qualit√© g√©n√©r√© automatiquement.
</footer>

<!-- SCRIPT DYNAMIQUE -->
<script>
    const jsonBasePaths = [
        "./data/" // local uniquement (GitHub Pages utilise la liste statique)
    ];

    async function findLatestJSON(prefix) {
        // D√©tecter si on est en local ou sur GitHub Pages
        const isLocal = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';

        // Liste statique des fichiers disponibles (fallback si le listage de dossier ne fonctionne pas)
        const staticFileList = [
            'lighthouse-1763634146672.json',
            'risk-levels-audit-1763634259430.json',
            'daltonisme-1763648733792.json',
            'fps-1763634225042.json',
            'a11y-1763635763804.json',
            'datasets-1763634247354.json',
            'audit-complet-1763634146592.json'
        ];

        // Mapping des pr√©fixes aux patterns de fichiers
        const prefixMapping = {
            'lighthouse': /^lighthouse-\d+\.json$/,
            'risk-levels': /^risk-levels-audit-\d+\.json$/,
            'daltonisme': /^daltonisme-\d+\.json$/,
            'fps': /^fps-\d+\.json$/,
            'a11y': /^a11y-\d+\.json$/,
            'datasets': /^datasets-\d+\.json$/,
            'audit-complet': /^audit-complet-\d+\.json$/
        };

        const pattern = prefixMapping[prefix];
        if (!pattern) {
            console.log(`Pattern non trouv√© pour le pr√©fixe: ${prefix}`);
            return null;
        }

        try {
            // Essayer d'abord de lister dynamiquement le dossier data
            const resp = await fetch("./data/");
            if (resp.ok) {
                const text = await resp.text();
                const matches = [...text.matchAll(/href="([^"]+\.json)"/g)]
                    .map(m => m[1])
                    .filter(name => pattern.test(name));
                if (matches.length > 0) {
                    matches.sort().reverse(); // Le plus r√©cent en premier (timestamp descendant)
                    console.log(`Fichier trouv√© pour ${prefix}: ${matches[0]}`);
                    return "./data/" + matches[0];
                }
            }
        } catch (e) {
            console.log(`Erreur lors du listage dynamique pour ${prefix}:`, e);
        }

        // Fallback : utiliser la liste statique
        const staticMatches = staticFileList.filter(name => pattern.test(name));
        if (staticMatches.length > 0) {
            staticMatches.sort().reverse();
            console.log(`Fichier statique trouv√© pour ${prefix}: ${staticMatches[0]}`);
            return "./data/" + staticMatches[0];
        }

        console.log(`Aucun fichier trouv√© pour le pr√©fixe: ${prefix}`);
        return null;
    }

    async function loadJSON(prefix) {
        const url = await findLatestJSON(prefix);
        if (!url) return null;
        const resp = await fetch(url);
        return resp.json();
    }

    async function loadAllData() {
        const lighthouse = await loadJSON('lighthouse');
        const wcag = await loadJSON('risk-levels');
        const daltonisme = await loadJSON('daltonisme');
        const fps = await loadJSON('fps');
        const a11y = await loadJSON('a11y');
        const datasets = await loadJSON('datasets');
        // NE PLUS charger audit complet ici (lazy load)
        renderCharts({ lighthouse, wcag, daltonisme, fps, a11y, datasets });
        // Placeholder audit synth√©tique l√©ger
        const auditLink = await findLatestJSON('audit-complet');
        const auditContent = document.getElementById('audit-rncp-content');
        auditContent.innerHTML = auditLink ? `<p class='text-sm'>Audit agr√©g√© disponible (<a class='underline text-[var(--sh-purple-300)]' href='${auditLink}' target='_blank' rel='noopener'>t√©l√©charger JSON</a>). Cliquez sur d√©tails pour charger.</p>` : `<p class='text-sm opacity-60'>Audit agr√©g√© non pr√©sent. G√©n√©rer via script.</p>`;
    }

    // Surcharge du bouton: charger audit au premier clic si pas d√©j√† charg√©
    let auditLoaded = false;
    async function toggleAuditDetails() {
        const details = document.getElementById('audit-details');
        details.classList.toggle('hidden');
        if (!auditLoaded && !details.classList.contains('hidden')) {
            const audit = await loadJSON('audit-complet');
            renderAudit(audit);
            auditLoaded = true;
        }
    }

    function renderCharts({ lighthouse, wcag, daltonisme, fps, a11y, datasets }) {
        // Nouvelle visualisation Lighthouse avec des cercles de score individuels
        if (lighthouse?.scores) {
            const scores = lighthouse.scores;
            const avgScore = Math.round((scores.performance + scores.accessibility + scores.seo + scores.bestPractices) / 4);

            // Fonction pour obtenir la couleur selon le score
            const getScoreColor = (score) => {
                if (score >= 90) return '#10b981'; // green
                if (score >= 70) return '#f59e0b'; // amber
                return '#ef4444'; // red
            };

            // Fonction pour obtenir la classe de couleur texte
            const getScoreTextClass = (score) => {
                if (score >= 90) return 'text-score-excellent';
                if (score >= 70) return 'text-score-good';
                return 'text-score-poor';
            };

            // Fonction pour obtenir la note alphab√©tique
            const getGradeLetter = (score) => {
                if (score >= 90) return 'A';
                if (score >= 80) return 'B';
                if (score >= 70) return 'C';
                if (score >= 60) return 'D';
                return 'F';
            };

            // Fonction pour obtenir la classe du badge de note
            const getGradeBadgeClass = (score) => {
                if (score >= 90) return 'badge-grade-a';
                if (score >= 80) return 'badge-grade-b';
                if (score >= 70) return 'badge-grade-c';
                if (score >= 60) return 'badge-grade-d';
                return 'badge-grade-f';
            };

            // Nouvelle visualisation avec cercles anim√©s et scores individuels
            const lighthouseContainer = document.getElementById("lighthouse-content");
            lighthouseContainer.innerHTML = `
                <div class="space-y-6">
                    <!-- Score moyen principal -->
                    <div class="text-center">
                        <div class="score-circle score-circle-large mx-auto">
                            <svg>
                                <circle cx="50%" cy="50%" r="45%" stroke="rgba(255,255,255,0.1)" stroke-width="4" fill="none"/>
                                <circle cx="50%" cy="50%" r="45%" stroke="${getScoreColor(avgScore)}"
                                        stroke-width="4" fill="none" stroke-linecap="round"
                                        class="score-circle-progress" data-score="${avgScore}"/>
                            </svg>
                            <div class="score-text">
                                <div class="text-2xl font-bold ${getScoreTextClass(avgScore)}">${avgScore}</div>
                                <div class="text-xs text-gray-400 mt-1">Score Global</div>
                            </div>
                        </div>
                        <div class="mt-3">
                            <div class="${getGradeBadgeClass(avgScore)} grade-badge mx-auto" style="width: 60px; height: 60px; font-size: 1.5rem;">
                                ${getGradeLetter(avgScore)}
                            </div>
                        </div>
                    </div>

                    <!-- Grille des scores individuels -->
                    <div class="grid grid-cols-2 gap-4">
                        <div class="text-center">
                            <div class="score-circle mx-auto">
                                <svg>
                                    <circle cx="50%" cy="50%" r="45%" stroke="rgba(255,255,255,0.1)" stroke-width="3" fill="none"/>
                                    <circle cx="50%" cy="50%" r="45%" stroke="${getScoreColor(scores.performance)}"
                                            stroke-width="3" fill="none" stroke-linecap="round"
                                            class="score-circle-progress" data-score="${scores.performance}"/>
                                </svg>
                                <div class="score-text">
                                    <div class="text-lg font-bold ${getScoreTextClass(scores.performance)}">${scores.performance}</div>
                                </div>
                            </div>
                            <div class="mt-2">
                                <div class="text-sm font-medium text-gray-300">Performance</div>
                                <div class="text-xs text-gray-500">Vitesse de chargement</div>
                            </div>
                        </div>

                        <div class="text-center">
                            <div class="score-circle mx-auto">
                                <svg>
                                    <circle cx="50%" cy="50%" r="45%" stroke="rgba(255,255,255,0.1)" stroke-width="3" fill="none"/>
                                    <circle cx="50%" cy="50%" r="45%" stroke="${getScoreColor(scores.accessibility)}"
                                            stroke-width="3" fill="none" stroke-linecap="round"
                                            class="score-circle-progress" data-score="${scores.accessibility}"/>
                                </svg>
                                <div class="score-text">
                                    <div class="text-lg font-bold ${getScoreTextClass(scores.accessibility)}">${scores.accessibility}</div>
                                </div>
                            </div>
                            <div class="mt-2">
                                <div class="text-sm font-medium text-gray-300">Accessibilit√©</div>
                                <div class="text-xs text-gray-500">Conformit√© a11y</div>
                            </div>
                        </div>

                        <div class="text-center">
                            <div class="score-circle mx-auto">
                                <svg>
                                    <circle cx="50%" cy="50%" r="45%" stroke="rgba(255,255,255,0.1)" stroke-width="3" fill="none"/>
                                    <circle cx="50%" cy="50%" r="45%" stroke="${getScoreColor(scores.seo)}"
                                            stroke-width="3" fill="none" stroke-linecap="round"
                                            class="score-circle-progress" data-score="${scores.seo}"/>
                                </svg>
                                <div class="score-text">
                                    <div class="text-lg font-bold ${getScoreTextClass(scores.seo)}">${scores.seo}</div>
                                </div>
                            </div>
                            <div class="mt-2">
                                <div class="text-sm font-medium text-gray-300">SEO</div>
                                <div class="text-xs text-gray-500">Optimisation moteurs</div>
                            </div>
                        </div>

                        <div class="text-center">
                            <div class="score-circle mx-auto">
                                <svg>
                                    <circle cx="50%" cy="50%" r="45%" stroke="rgba(255,255,255,0.1)" stroke-width="3" fill="none"/>
                                    <circle cx="50%" cy="50%" r="45%" stroke="${getScoreColor(scores.bestPractices)}"
                                            stroke-width="3" fill="none" stroke-linecap="round"
                                            class="score-circle-progress" data-score="${scores.bestPractices}"/>
                                </svg>
                                <div class="score-text">
                                    <div class="text-lg font-bold ${getScoreTextClass(scores.bestPractices)}">${scores.bestPractices}</div>
                                </div>
                            </div>
                            <div class="mt-2">
                                <div class="text-sm font-medium text-gray-300">Bonnes Pratiques</div>
                                <div class="text-xs text-gray-500">Standards web</div>
                            </div>
                        </div>
                    </div>

                    <!-- L√©gende des scores -->
                    <div class="flex justify-center space-x-4 text-xs pt-3 border-t border-white/10">
                        <div class="flex items-center space-x-1">
                            <span class="w-2 h-2 bg-green-500 rounded-full"></span>
                            <span class="text-gray-400">‚â•90 Excellent</span>
                        </div>
                        <div class="flex items-center space-x-1">
                            <span class="w-2 h-2 bg-amber-500 rounded-full"></span>
                            <span class="text-gray-400">70-89 Bon</span>
                        </div>
                        <div class="flex items-center space-x-1">
                            <span class="w-2 h-2 bg-red-500 rounded-full"></span>
                            <span class="text-gray-400">&lt;70 √Ä am√©liorer</span>
                        </div>
                    </div>

                    <!-- M√©triques d√©taill√©es si disponibles -->
                    ${lighthouse.metrics ? `
                        <div class="mt-4 pt-4 border-t border-white/10">
                            <div class="text-xs text-gray-400 mb-2">M√©triques Web Vitals</div>
                            <div class="grid grid-cols-2 gap-2 text-xs">
                                <div class="flex justify-between p-2 bg-gray-800/50 rounded">
                                    <span class="text-gray-300">FCP</span>
                                    <span class="font-mono text-gray-200">${lighthouse.metrics.fcp || 'N/A'}</span>
                                </div>
                                <div class="flex justify-between p-2 bg-gray-800/50 rounded">
                                    <span class="text-gray-300">LCP</span>
                                    <span class="font-mono text-gray-200">${lighthouse.metrics.lcp || 'N/A'}</span>
                                </div>
                                <div class="flex justify-between p-2 bg-gray-800/50 rounded">
                                    <span class="text-gray-300">TBT</span>
                                    <span class="font-mono text-gray-200">${lighthouse.metrics.tbt || 'N/A'}</span>
                                </div>
                                <div class="flex justify-between p-2 bg-gray-800/50 rounded">
                                    <span class="text-gray-300">CLS</span>
                                    <span class="font-mono text-gray-200">${lighthouse.metrics.cls || 'N/A'}</span>
                                </div>
                            </div>
                        </div>
                    ` : ''}
                </div>
            `;

            // Ajouter l'animation apr√®s un court d√©lai pour l'effet visuel
            setTimeout(() => {
                const progressRings = lighthouseContainer.querySelectorAll('.score-circle-progress');
                progressRings.forEach(ring => {
                    const score = parseInt(ring.getAttribute('data-score'));

                    // D√©tecter la taille du cercle pour ajuster la circonf√©rence
                    const isLargeCircle = ring.closest('.score-circle-large') !== null;

                    // Circonf√©rence ajust√©e selon la taille du cercle
                    // Cercle large (140px) vs cercle normal (100px) = ratio 1.4
                    const circumference = isLargeCircle ? 396 : 283; // 283 * 1.4 ‚âà 396

                    // Calculer le dash array pour le pourcentage de score
                    const strokeDashArray = (score / 100) * circumference;

                    ring.style.strokeDasharray = `${strokeDashArray} ${circumference}`;
                });
            }, 200);

        } else {
            document.getElementById("lighthouse-content").innerHTML =
                '<div class="flex items-center justify-center h-32 text-gray-400"><p>‚è≥ Analyse Lighthouse en cours...</p></div>';
        }

        // WCAG - Nouvelle version avec onglets et informations d√©taill√©es
        if (wcag) {
            try {
                // Extraire les donn√©es selon la vraie structure du JSON risk-levels-audit
                let critiques = 0, eleves = 0, moyens = 0, faibles = 0;
                const detailedProblems = {
                    critical: [],
                    high: [],
                    medium: [],
                    low: []
                };

                if (wcag.contraste) {
                    Object.entries(wcag.contraste).forEach(([themeName, theme]) => {
                        if (theme.tests) {
                            theme.tests.forEach(test => {
                                // Ne traiter que les tests qui √©chouent
                                if (!test.passesNormal && test.ratio != null && test.hex) {
                                // D√©terminer la criticit√© selon l'√©cart au seuil WCAG AA (4.5:1)
                                const requiredRatio = 4.5;
                                const gap = requiredRatio - test.ratio;
                                let problemLevel = 'medium';

                                if (gap >= 2.0) problemLevel = 'critical'; // Tr√®s loin du seuil
                                else if (gap >= 1.0) problemLevel = 'high'; // Assez loin
                                else if (gap >= 0.5) problemLevel = 'medium'; // Proche
                                else problemLevel = 'low'; // Tr√®s proche

                                const problem = {
                                    riskLevel: test.level || 'unknown', // critical, high, medium, low (risk level du stock)
                                    color: test.hex,
                                    ratio: test.ratio.toFixed(2),
                                    expected: requiredRatio.toFixed(1),
                                    theme: themeName,
                                    passesLarge: test.passesLarge || false,
                                    wcagLevel: test.wcagLevel || 'FAIL',
                                    gap: gap.toFixed(2),
                                    location: 'Design System: sh-stock-prediction-card',
                                    file: 'stockhub_design_system/src/components/organisms/sh-stock-prediction-card',
                                    problemLevel: problemLevel
                                };

                                switch(problemLevel) {
                                    case 'critical':
                                        critiques++;
                                        detailedProblems.critical.push(problem);
                                        break;
                                    case 'high':
                                        eleves++;
                                        detailedProblems.high.push(problem);
                                        break;
                                    case 'medium':
                                        moyens++;
                                        detailedProblems.medium.push(problem);
                                        break;
                                    case 'low':
                                        faibles++;
                                        detailedProblems.low.push(problem);
                                        break;
                                }
                            }
                        });
                    }
                });
            }

            const total = critiques + eleves + moyens + faibles;

            // Cr√©er le graphique WCAG
            new Chart(document.getElementById("chart-wcag"), {
                type: "bar",
                data: {
                    labels: ["üî¥ Critique", "üü† √âlev√©", "üü° Moyen", "üü¢ Faible"],
                    datasets: [{
                        data: [critiques, eleves, moyens, faibles],
                        backgroundColor: ["#ef4444", "#f97316", "#facc15", "#4ade80"],
                        borderRadius: 4
                    }]
                },
                options: {
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const percentage = total > 0 ? ((context.parsed.y / total) * 100).toFixed(1) : 0;
                                    return `${context.parsed.y} probl√®mes (${percentage}%)`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { color: '#9ca3af' }
                        },
                        x: {
                            ticks: { color: '#9ca3af' }
                        }
                    }
                }
            });

            // Fonction pour initialiser les onglets WCAG
            function initWcagTabs() {
                const tabs = document.querySelectorAll('.wcag-tab');
                const panels = document.querySelectorAll('.wcag-panel');

                tabs.forEach(tab => {
                    tab.addEventListener('click', () => {
                        const targetPanel = tab.dataset.tab;

                        // D√©sactiver tous les onglets et panneaux
                        tabs.forEach(t => t.classList.remove('active'));
                        panels.forEach(p => p.classList.remove('active'));

                        // Activer l'onglet et le panneau s√©lectionn√©s
                        tab.classList.add('active');
                        const panel = document.querySelector(`[data-panel="${targetPanel}"]`);
                        if (panel) panel.classList.add('active');
                    });
                });
            }

            // Fonction pour remplir les onglets de probl√®mes
            function populateWcagProblems() {
                const levels = ['critical', 'high', 'medium', 'low'];
                const levelColors = {
                    critical: 'border-red-500 bg-red-500/10',
                    high: 'border-orange-500 bg-orange-500/10',
                    medium: 'border-yellow-500 bg-yellow-500/10',
                    low: 'border-green-500 bg-green-500/10'
                };

                levels.forEach(level => {
                    const container = document.getElementById(`${level}-problems`);
                    const problems = detailedProblems[level];

                    if (!container) return;

                    if (!problems || problems.length === 0) {
                        container.innerHTML = `
                            <div class="flex flex-col items-center justify-center h-32 text-gray-400">
                                <div class="text-4xl mb-2">‚úÖ</div>
                                <p>Aucun probl√®me de niveau ${level}</p>
                            </div>
                        `;
                        return;
                    }

                    container.innerHTML = `
                        <div class="space-y-4">
                            <h3 class="text-lg font-semibold text-gray-200 mb-4">
                                ${problems.length} probl√®me${problems.length > 1 ? 's' : ''} de niveau ${level}
                            </h3>
                            ${problems.map((problem, index) => `
                                <div class="p-4 ${levelColors[level]} border rounded-lg">
                                    <div class="flex justify-between items-start mb-3">
                                        <div class="font-medium text-gray-200 flex items-center gap-2">
                                            <div class="w-6 h-6 rounded border-2 border-white/30" style="background-color: ${problem.color}" title="${problem.color}"></div>
                                            Risk Level "${problem.riskLevel}" - Th√®me ${problem.theme}
                                        </div>
                                        <span class="text-xs px-2 py-1 bg-gray-600 text-gray-200 rounded">
                                            ${level.toUpperCase()}
                                        </span>
                                    </div>

                                    <div class="space-y-2 text-sm text-gray-300">
                                        <div class="grid grid-cols-2 gap-3">
                                            <div><strong>Couleur:</strong> <code class="bg-gray-700 px-2 py-0.5 rounded">${problem.color}</code></div>
                                            <div><strong>Th√®me:</strong> ${problem.theme}</div>
                                            <div><strong>Ratio actuel:</strong> <span class="text-red-400">${problem.ratio}:1</span></div>
                                            <div><strong>Ratio requis:</strong> <span class="text-green-400">${problem.expected}:1</span></div>
                                            <div><strong>√âcart:</strong> <span class="text-orange-400">${problem.gap}</span></div>
                                            <div><strong>Texte large:</strong> ${problem.passesLarge ? '‚úÖ Passe' : '‚ùå √âchoue'}</div>
                                        </div>

                                        <div class="mt-3 p-3 bg-purple-500/10 border border-purple-500/20 rounded">
                                            <strong class="text-purple-300">üìç Emplacement:</strong>
                                            <div class="text-xs mt-2 space-y-1">
                                                <div>‚Ä¢ <strong>Composant:</strong> ${problem.location}</div>
                                                <div>‚Ä¢ <strong>Chemin:</strong> <code class="bg-gray-700 px-1 rounded">${problem.file}</code></div>
                                                <div>‚Ä¢ <strong>Variable √† chercher:</strong> <code class="bg-gray-700 px-1 rounded">${problem.riskLevel}</code> dans le mode <code class="bg-gray-700 px-1 rounded">${problem.theme}</code></div>
                                            </div>
                                        </div>

                                        <div class="mt-3 p-3 bg-blue-500/10 border border-blue-500/20 rounded">
                                            <strong class="text-blue-300">üí° Comment corriger:</strong>
                                            <div class="text-xs mt-2 space-y-1">
                                                <div>1. Ouvrir le repo Design System: <code class="bg-gray-700 px-1 rounded">C:\\Users\\sandr\\Dev\\RNCP7\\stockhub_design_system</code></div>
                                                <div>2. Chercher le fichier <code class="bg-gray-700 px-1 rounded">sh-stock-prediction-card</code></div>
                                                <div>3. Trouver la couleur <code class="bg-gray-700 px-1 rounded">${problem.color}</code> pour risk level "${problem.riskLevel}" en mode ${problem.theme}</div>
                                                <div>4. Remplacer par une couleur plus fonc√©e (ex: <code class="bg-gray-700 px-1 rounded">#b45309</code> ratio 5.02:1)</div>
                                                <div>5. Tester avec WebAIM: <a href="https://webaim.org/resources/contrastchecker/?fcolor=${problem.color.replace('#','')}&bcolor=${problem.theme === 'dark' ? '1e293b' : 'ffffff'}" class="text-blue-400 underline" target="_blank">Ouvrir WebAIM</a></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    `;
                });
            }

            // Remplir l'onglet solutions
            document.getElementById('wcag-solutions').innerHTML = `
                <div class="space-y-6">
                    <h3 class="text-lg font-semibold text-gray-200"><span>üõ†Ô∏è Outils et ressources</span></h3>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                        <div class="p-4 bg-blue-500/10 border border-blue-500/20 rounded-lg">
                            <h4 class="font-medium text-blue-300 mb-2">WebAIM Contrast Checker</h4>
                            <p class="text-xs text-gray-300 mb-2">Outil gratuit pour tester le contraste</p>
                            <a href="https://webaim.org/resources/contrastchecker/" class="text-blue-400 underline text-xs" target="_blank">
                                ‚Üí Ouvrir WebAIM
                            </a>
                        </div>
                        <div class="p-4 bg-green-500/10 border border-green-500/20 rounded-lg">
                            <h4 class="font-medium text-green-300 mb-2">DevTools navigateur</h4>
                            <p class="text-xs text-gray-300">F12 > Onglet Accessibility</p>
                        </div>
                    </div>

                    <div class="border-t border-gray-600 pt-4">
                        <h4 class="font-medium text-gray-200 mb-3">Standards WCAG 2.1</h4>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-3 text-xs">
                            <div class="p-3 bg-green-500/10 border border-green-500/20 rounded">
                                <div class="font-medium text-green-300">AAA (‚â• 7:1)</div>
                                <div class="text-gray-300">Excellent</div>
                            </div>
                            <div class="p-3 bg-yellow-500/10 border border-yellow-500/20 rounded">
                                <div class="font-medium text-yellow-300">AA (‚â• 4.5:1)</div>
                                <div class="text-gray-300">Standard requis</div>
                            </div>
                            <div class="p-3 bg-blue-500/10 border border-blue-500/20 rounded">
                                <div class="font-medium text-blue-300">UI (‚â• 3:1)</div>
                                <div class="text-gray-300">Interface</div>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // Mettre √† jour le badge de statut
            const wcagStatusBadge = document.getElementById('wcag-status-badge');
            if (wcagStatusBadge) {
                const hasCritical = critiques > 0;
                wcagStatusBadge.className = `text-xs px-3 py-1 rounded-full ${
                    hasCritical ? 'bg-red-500/20 text-red-400' : 'bg-green-500/20 text-green-400'
                }`;
                wcagStatusBadge.textContent = hasCritical ? `${critiques} Critique${critiques > 1 ? 's' : ''}` : '‚úÖ Conforme';
            }

            // Initialiser les onglets et remplir le contenu
            setTimeout(() => {
                initWcagTabs();
                populateWcagProblems();
            }, 100);

            } catch (error) {
                console.error('Erreur lors du traitement des donn√©es WCAG:', error);
                document.getElementById("chart-wcag").innerHTML =
                    '<div class="flex items-center justify-center h-32 text-red-400"><p>‚ùå Erreur lors du chargement des donn√©es WCAG</p></div>';
            }
        } else {
            document.getElementById("chart-wcag").innerHTML =
                '<div class="flex items-center justify-center h-32 text-gray-400"><p>‚è≥ Analyse WCAG en cours...</p></div>';
        }

        // Daltonisme - Affichage am√©lior√© avec tous les tests d√©taill√©s
        if (daltonisme) {
            // Analyser les donn√©es de contraste daltonisme
            const stats = { passed: 0, failed: 0, aaa: 0, aa: 0, fail: 0 };
            const allTests = [];

            if (daltonisme.contraste && daltonisme.contraste.tests) {
                daltonisme.contraste.tests.forEach(test => {
                    if (test.passes) stats.passed++;
                    else stats.failed++;

                    switch(test.level) {
                        case 'AAA': stats.aaa++; break;
                        case 'AA': stats.aa++; break;
                        case 'FAIL': stats.fail++; break;
                    }

                    // Ajouter le test √† la liste compl√®te
                    allTests.push({
                        ...test,
                        type: 'contraste'
                    });
                });
            }

            // Analyser les autres types de tests s'ils existent
            Object.entries(daltonisme).forEach(([testType, testData]) => {
                if (testType !== 'contraste' && testData && testData.tests) {
                    testData.tests.forEach(test => {
                        allTests.push({
                            ...test,
                            type: testType
                        });
                    });
                }
            });

            // Fonctions pour la gestion des onglets daltonisme
            function initDaltonismeTabs() {
                const tabs = document.querySelectorAll('.daltonisme-tab');
                const panels = document.querySelectorAll('.daltonisme-panel');

                tabs.forEach(tab => {
                    tab.addEventListener('click', () => {
                        const targetPanel = tab.dataset.tab;

                        // D√©sactiver tous les onglets et panneaux
                        tabs.forEach(t => t.classList.remove('active'));
                        panels.forEach(p => p.classList.remove('active'));

                        // Activer l'onglet et le panneau s√©lectionn√©s
                        tab.classList.add('active');
                        const panel = document.querySelector(`[data-panel="${targetPanel}"]`);
                        if (panel) panel.classList.add('active');
                    });
                });
            }

            // Fonction pour remplir les couleurs de statut
            function populateStatusColors() {
                const STATUS_COLORS = {
                    optimal: { name: 'Optimal', light: '#10b981', dark: '#34d399', label: '‚úì' },
                    low: { name: 'Stock Faible', light: '#f59e0b', dark: '#fbbf24', label: '‚ö†' },
                    critical: { name: 'Critique', light: '#ef4444', dark: '#f87171', label: '!' },
                    outOfStock: { name: 'Rupture', light: '#6b7280', dark: '#9ca3af', label: '‚úï' },
                    overstocked: { name: 'Surstock', light: '#3b82f6', dark: '#60a5fa', label: '‚Üë' }
                };

                const colorGrid = document.getElementById('color-status-grid');
                if (colorGrid) {
                    colorGrid.innerHTML = Object.entries(STATUS_COLORS).map(([key, status]) => `
                        <div class="flex items-center gap-2 p-2 bg-gray-700/30 rounded">
                            <div class="color-preview" style="background-color: ${status.light}" title="${status.name} (light mode)"></div>
                            <div class="color-preview" style="background-color: ${status.dark}" title="${status.name} (dark mode)"></div>
                            <span class="text-xs text-gray-300">${status.label} ${status.name}</span>
                        </div>
                    `).join('');
                }
            }

            // Fonction pour remplir les tests de contraste
            function populateContrastTests() {
                const contrastGrid = document.getElementById('contrast-tests-grid');
                if (contrastGrid && daltonisme.contraste && daltonisme.contraste.tests) {
                    contrastGrid.innerHTML = daltonisme.contraste.tests.map(test => {
                        // Calculer la conformit√© r√©elle bas√©e sur le ratio de contraste
                        const ratio = test.ratio || test.contrastRatio || 0;
                        const expectedRatio = test.expectedRatio || (test.level === 'AAA' ? 7.0 : test.level === 'AA' ? 4.5 : 3.0);

                        // D√©terminer la conformit√© r√©elle
                        const actuallyPasses = ratio >= expectedRatio;

                        // Recalculer le level bas√© sur le ratio r√©el
                        let actualLevel = 'FAIL';
                        if (ratio >= 7.0) {
                            actualLevel = 'AAA';
                        } else if (ratio >= 4.5) {
                            actualLevel = 'AA';
                        } else if (ratio >= 3.0) {
                            actualLevel = 'UI';
                        }

                        const levelColor = actualLevel === 'AAA' ? 'border-green-500 bg-green-900/20' :
                                         actualLevel === 'AA' ? 'border-yellow-500 bg-yellow-900/20' :
                                         actualLevel === 'UI' ? 'border-blue-500 bg-blue-900/20' :
                                         'border-red-500 bg-red-900/20';

                        const statusIcon = actuallyPasses ? '‚úÖ' : '‚ùå';
                        const statusText = actuallyPasses ? 'Conforme' : 'Non conforme';
                        const statusColor = actuallyPasses ? 'text-green-400' : 'text-red-400';

                        // Extraire le contexte du test pour plus de clart√©
                        const testContext = test.context || test.description || test.selector || '√âl√©ment non sp√©cifi√©';
                        const testType = test.type || 'Contraste de couleur';
                        const backgroundMode = test.background || 'mode non sp√©cifi√©';
                        const statusType = test.status || 'statut non sp√©cifi√©';

                        // D√©terminer l'ic√¥ne et la couleur du mode
                        let modeDisplay = '';
                        if (backgroundMode === 'dark') {
                            modeDisplay = `<span class="inline-flex items-center gap-1 px-2 py-1 text-xs bg-gray-800 text-gray-200 rounded-md border border-gray-600">
                                üåô Mode sombre
                            </span>`;
                        } else if (backgroundMode === 'light') {
                            modeDisplay = `<span class="inline-flex items-center gap-1 px-2 py-1 text-xs bg-gray-100 text-gray-800 rounded-md border border-gray-300">
                                ‚òÄÔ∏è Mode clair
                            </span>`;
                        } else {
                            modeDisplay = `<span class="inline-flex items-center gap-1 px-2 py-1 text-xs bg-purple-500/20 text-purple-300 rounded-md border border-purple-500/30">
                                ‚ùì ${backgroundMode}
                            </span>`;
                        }

                        // Affichage du type de statut test√©
                        const statusColors = {
                            optimal: 'bg-green-500/20 text-green-400 border-green-500/30',
                            low: 'bg-yellow-500/20 text-yellow-400 border-yellow-500/30',
                            critical: 'bg-red-500/20 text-red-400 border-red-500/30',
                            outOfStock: 'bg-gray-500/20 text-gray-400 border-gray-500/30',
                            overstocked: 'bg-blue-500/20 text-blue-400 border-blue-500/30'
                        };
                        const statusColorClass = statusColors[statusType] || 'bg-purple-500/20 text-purple-300 border-purple-500/30';

                        let statusDisplay = `<span class="inline-flex items-center gap-1 px-2 py-1 text-xs rounded-md border ${statusColorClass}">
                            üìä ${statusType}
                        </span>`;

                        // Informations sur les couleurs test√©es
                        let colorInfo = '';
                        if (test.foregroundColor && test.backgroundColor) {
                            colorInfo = `Texte: ${test.foregroundColor} sur ${test.backgroundColor}`;
                        } else if (test.colors) {
                            const colors = Object.entries(test.colors).map(([key, value]) => `${key}: ${value}`).join(' / ');
                            colorInfo = colors;
                        } else if (test.element) {
                            colorInfo = `√âl√©ment: ${test.element}`;
                        }

                        return `
                            <div class="p-4 ${levelColor} border rounded-lg">
                                <div class="flex justify-between items-start mb-3">
                                    <div class="flex items-center gap-2">
                                        <span class="text-lg">${statusIcon}</span>
                                        <div class="flex-1">
                                            <div class="font-medium ${statusColor}">${statusText}</div>
                                            <div class="mt-2 flex flex-wrap gap-2">
                                                ${modeDisplay}
                                                ${statusDisplay}
                                            </div>
                                            ${colorInfo ? `<div class="text-xs text-blue-300 mt-2">${colorInfo}</div>` : ''}
                                        </div>
                                    </div>
                                    <span class="px-2 py-1 text-xs font-medium rounded-full ${
                                        actualLevel === 'AAA' ? 'bg-green-500/20 text-green-400' :
                                        actualLevel === 'AA' ? 'bg-yellow-500/20 text-yellow-400' :
                                        actualLevel === 'UI' ? 'bg-blue-500/20 text-blue-400' :
                                        'bg-red-500/20 text-red-400'
                                    }">
                                        ${actualLevel}
                                    </span>
                                </div>
                                <div class="space-y-2 text-sm">
                                    <div class="flex justify-between">
                                        <span class="text-gray-300">Ratio de contraste:</span>
                                        <span class="font-mono ${statusColor}">${test.ratio?.toFixed(2) || 'N/A'}:1</span>
                                    </div>
                                    ${test.expectedRatio ? `
                                        <div class="flex justify-between text-xs">
                                            <span class="text-gray-400">Requis:</span>
                                            <span class="font-mono text-gray-300">${test.expectedRatio}:1</span>
                                        </div>
                                    ` : ''}
                                    <div class="text-xs ${statusColor} bg-gray-800/50 p-2 rounded">
                                        ${test.passes ?
                                            '‚úÖ Respecte les standards WCAG - Lisible pour tous les utilisateurs' :
                                            '‚ùå Contraste insuffisant - Difficile √† lire pour les utilisateurs malvoyants'
                                        }
                                    </div>
                                    ${testContext && testContext !== '√âl√©ment non sp√©cifi√©' ? `
                                        <div class="text-xs text-gray-500 border-t border-gray-700 pt-2 mt-2">
                                            <span class="font-medium">Contexte:</span> ${testContext}
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                        `;
                    }).join('');
                }
            }

            // Fonction pour remplir les simulations de daltonisme
            function populateSimulations() {
                const simulationGrid = document.getElementById('simulation-grid');
                if (simulationGrid && daltonisme.daltonisme) {
                    const daltonismTypes = {
                        protanopia: { name: 'Protanopie', desc: 'D√©ficit rouge-vert (~1% hommes)', color: '#ef4444' },
                        deuteranopia: { name: 'Deut√©ranopie', desc: 'D√©ficit rouge-vert (~1% hommes)', color: '#f59e0b' },
                        tritanopia: { name: 'Tritanopie', desc: 'D√©ficit bleu-jaune (~0.01%)', color: '#3b82f6' },
                        achromatopsie: { name: 'Achromatopsie', desc: 'Monochrome (tr√®s rare)', color: '#6b7280' }
                    };

                    simulationGrid.innerHTML = Object.entries(daltonisme.daltonisme).map(([type, data]) => {
                        const typeInfo = daltonismTypes[type] || { name: type, desc: 'Type de daltonisme', color: '#8b5cf6' };
                        const passedDifferences = data.differences?.filter(d => d.differentiable).length || 0;
                        const totalDifferences = data.differences?.length || 0;
                        const percentage = totalDifferences > 0 ? ((passedDifferences / totalDifferences) * 100).toFixed(0) : 0;

                        return `
                            <div class="daltonism-type-card">
                                <div class="flex items-center gap-3 mb-4">
                                    <div class="w-4 h-4 rounded-full" style="background-color: ${typeInfo.color}"></div>
                                    <div>
                                        <h4 class="font-semibold text-gray-200">${typeInfo.name}</h4>
                                        <p class="text-xs text-gray-400">${typeInfo.desc}</p>
                                    </div>
                                </div>

                                <div class="space-y-3">
                                    <div class="flex justify-between items-center">
                                        <span class="text-sm text-gray-300">Diff√©rentiabilit√©:</span>
                                        <div class="flex items-center gap-2">
                                            <span class="text-lg ${data.allDifferentiable ? '‚úÖ' : '‚ö†Ô∏è'}">${data.allDifferentiable ? '‚úÖ' : '‚ö†Ô∏è'}</span>
                                            <span class="font-semibold ${percentage >= 80 ? 'text-green-400' : percentage >= 60 ? 'text-yellow-400' : 'text-red-400'}">
                                                ${percentage}%
                                            </span>
                                        </div>
                                    </div>

                                    <div class="text-xs text-gray-400">
                                        ${passedDifferences}/${totalDifferences} paires de couleurs distinguables
                                    </div>

                                    ${data.simulatedColors ? `
                                        <div class="mt-3">
                                            <div class="text-xs text-gray-300 mb-2">Aper√ßu des couleurs simul√©es:</div>
                                            <div class="flex gap-1">
                                                ${Object.entries(data.simulatedColors).map(([status, colors]) => `
                                                    <div class="tooltip-wrapper" tabindex="0">
                                                        <div class="color-preview simulated" style="background-color: ${colors.simulated}" title="Couleur simul√©e"></div>
                                                        <div class="tooltip-box">
                                                            <div class="font-medium">${status}</div>
                                                            <div>Original: ${colors.original}</div>
                                                            <div>Simul√©: ${colors.simulated}</div>
                                                        </div>
                                                    </div>
                                                `).join('')}
                                            </div>
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                        `;
                    }).join('');
                }
            }

            // Fonction pour remplir l'analyse de diff√©rentiabilit√©
            function populateDifferenceAnalysis() {
                const differenceContainer = document.getElementById('difference-analysis');
                if (differenceContainer && daltonisme.daltonisme) {
                    differenceContainer.innerHTML = Object.entries(daltonisme.daltonisme).map(([type, data]) => {
                        const differences = data.differences || [];

                        return `
                            <div class="space-y-4">
                                <h4 class="text-lg font-semibold text-gray-200 capitalize">${type}</h4>
                                <div class="grid grid-cols-1 gap-3">
                                    ${differences.map(diff => {
                                        const deltaClass = diff.differentiable ? 'delta-e-good' :
                                                         diff.deltaSimulated >= 30 ? 'delta-e-warning' : 'delta-e-critical';

                                        return `
                                            <div class="p-4 bg-gray-800/50 border border-gray-700/50 rounded-lg">
                                                <div class="flex justify-between items-start mb-2">
                                                    <div class="text-sm text-gray-200">${diff.pair}</div>
                                                    <div class="flex items-center gap-2">
                                                        <span class="text-lg">${diff.differentiable ? '‚úÖ' : '‚ö†Ô∏è'}</span>
                                                        <span class="delta-e-indicator ${deltaClass}">
                                                            ŒîE: ${diff.deltaSimulated?.toFixed(1) || 'N/A'}
                                                        </span>
                                                    </div>
                                                </div>
                                                <div class="flex justify-between text-xs text-gray-400">
                                                    <span>Original ŒîE: ${diff.deltaOriginal?.toFixed(1) || 'N/A'}</span>
                                                    <span>Seuil: ‚â•40 pour diff√©rentiation</span>
                                                </div>
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                            </div>
                        `;
                    }).join('');
                }
            }

            // Mettre √† jour les m√©triques principales
            function updateMainMetrics() {
                const contrastScore = document.getElementById('contrast-score');
                const daltonismScore = document.getElementById('daltonism-score');
                const statusBadge = document.getElementById('daltonisme-status-badge');
                const globalSummary = document.getElementById('global-summary');

                if (contrastScore) {
                    const contrastPercent = stats.passed + stats.failed > 0 ?
                        Math.round((stats.passed / (stats.passed + stats.failed)) * 100) : 0;
                    contrastScore.textContent = `${contrastPercent}%`;
                }

                if (daltonismScore && daltonisme.daltonisme) {
                    const daltonismTypes = Object.values(daltonisme.daltonisme);
                    const allDifferentiable = daltonismTypes.filter(d => d.allDifferentiable).length;
                    const totalTypes = daltonismTypes.length;
                    const daltonismPercent = totalTypes > 0 ? Math.round((allDifferentiable / totalTypes) * 100) : 0;
                    daltonismScore.textContent = `${daltonismPercent}%`;
                }

                if (statusBadge) {
                    const overallStatus = (stats.passed > stats.failed) &&
                        Object.values(daltonisme.daltonisme || {}).every(d => d.allDifferentiable);
                    statusBadge.className = `text-xs px-3 py-1 rounded-full ${
                        overallStatus ? 'bg-green-500/20 text-green-400' : 'bg-yellow-500/20 text-yellow-400'
                    }`;
                    statusBadge.textContent = overallStatus ? '‚úÖ Conforme' : '‚ö†Ô∏è √Ä am√©liorer';
                }

                if (globalSummary) {
                    const totalTests = allTests.length;
                    const passedTests = stats.passed;
                    const daltonismTypes = Object.keys(daltonisme.daltonisme || {}).length;

                    globalSummary.innerHTML = `
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-center">
                            <div>
                                <div class="text-2xl font-bold text-blue-400">${totalTests}</div>
                                <div class="text-xs text-gray-400">Tests de contraste</div>
                            </div>
                            <div>
                                <div class="text-2xl font-bold text-purple-400">${daltonismTypes}</div>
                                <div class="text-xs text-gray-400">Types de daltonisme</div>
                            </div>
                            <div>
                                <div class="text-2xl font-bold ${passedTests > (totalTests - passedTests) ? 'text-green-400' : 'text-red-400'}">
                                    ${totalTests > 0 ? Math.round((passedTests / totalTests) * 100) : 0}%
                                </div>
                                <div class="text-xs text-gray-400">Conformit√© globale</div>
                            </div>
                        </div>
                    `;
                }
            }

            const daltonismeContainer = document.getElementById("chart-daltonisme").parentElement;

            // Cr√©er le graphique en donut (plus petit maintenant)
            new Chart(document.getElementById("chart-daltonisme"), {
                type: "doughnut",
                data: {
                    labels: ["Tests r√©ussis", "Tests √©chou√©s"],
                    datasets: [{
                        data: [stats.passed, stats.failed],
                        backgroundColor: ["#10b981", "#ef4444"],
                        borderWidth: 0
                    }]
                },
                options: {
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const total = stats.passed + stats.failed;
                                    const percentage = ((context.parsed / total) * 100).toFixed(1);
                                    return `${context.label}: ${context.parsed} (${percentage}%)`;
                                }
                            }
                        }
                    },
                    cutout: '60%'
                }
            });

            // Ajouter l'overlay avec statistiques centrales
            const overlay = document.createElement('div');
            overlay.className = 'chart-overlay';
            overlay.innerHTML = `
                <div class="chart-overlay-text">
                    <div class="text-2xl font-bold ${stats.passed > stats.failed ? 'text-green-400' : 'text-red-400'}">
                        ${stats.passed + stats.failed > 0 ? ((stats.passed / (stats.passed + stats.failed)) * 100).toFixed(0) : 0}%
                    </div>
                    <div class="text-xs text-gray-300 font-medium">Conformit√©</div>
                </div>
            `;
            daltonismeContainer.appendChild(overlay);

            // Initialiser tous les composants de la section daltonisme
            setTimeout(() => {
                initDaltonismeTabs();
                populateStatusColors();
                populateContrastTests();
                populateSimulations();
                populateDifferenceAnalysis();
                updateMainMetrics();
            }, 100);

        } else {
            document.getElementById("chart-daltonisme").innerHTML =
                '<div class="flex items-center justify-center h-32 text-gray-400"><p>‚è≥ Test daltonisme en cours...</p></div>';
        }

        // FPS - Affichage am√©lior√© avec graphique circulaire SVG
        const fpsEl = document.getElementById("fps-result");
        if (fps?.avgOverall != null) {
            const avgFps = parseFloat(fps.avgOverall);
            const statusIcon = fps.allPassed ? '‚úÖ' : '‚ùå';
            const statusColor = fps.allPassed ? 'text-green-400' : 'text-red-400';
            const testsCount = fps.tests?.length || 0;
            const progressPercent = Math.min(100, (avgFps / 60) * 100);
            const strokeDasharray = `${progressPercent * 2.51} 251`;

            fpsEl.innerHTML = `
                <div class="space-y-4">
                    <div class="flex items-center justify-between">
                        <div class="relative">
                            <svg class="w-16 h-16 transform -rotate-90" viewBox="0 0 84 84">
                                <circle cx="42" cy="42" r="40" stroke="rgba(255,255,255,0.1)" stroke-width="4" fill="none"/>
                                <circle cx="42" cy="42" r="40" stroke="${avgFps >= 60 ? '#10b981' : avgFps >= 45 ? '#f59e0b' : '#ef4444'}"
                                        stroke-width="4" fill="none" stroke-linecap="round"
                                        stroke-dasharray="${strokeDasharray}" class="transition-all duration-1000 ease-out"/>
                            </svg>
                            <div class="absolute inset-0 flex items-center justify-center">
                                <div class="text-center">
                                    <div class="text-lg font-bold ${statusColor}">${avgFps.toFixed(0)}</div>
                                    <div class="text-xs text-gray-400">FPS</div>
                                </div>
                            </div>
                        </div>
                        <div class="flex-1 ml-4 space-y-2">
                            <div class="flex items-center justify-between">
                                <span class="text-sm font-medium">Performance</span>
                                <span class="text-2xl">${statusIcon}</span>
                            </div>
                            <div class="text-xs text-gray-300">${testsCount} tests ‚Ä¢ ${avgFps.toFixed(1)} FPS moyen</div>
                            <div class="text-xs ${fps.allPassed ? 'text-green-400' : 'text-red-400'}">
                                ${fps.allPassed ? 'Animations fluides ‚ú®' : 'Optimisation requise ‚ö†Ô∏è'}
                            </div>
                        </div>
                    </div>
                    <div class="grid grid-cols-3 gap-2 text-center text-xs">
                        <div class="p-2 bg-gray-800 rounded">
                            <div class="text-green-400 font-semibold">${fps.tests?.filter(t => t.passed).length || 0}</div>
                            <div class="text-gray-400">Pass√©s</div>
                        </div>
                        <div class="p-2 bg-gray-800 rounded">
                            <div class="text-red-400 font-semibold">${fps.tests?.filter(t => !t.passed).length || 0}</div>
                            <div class="text-gray-400">√âchou√©s</div>
                        </div>
                        <div class="p-2 bg-gray-800 rounded">
                            <div class="text-blue-400 font-semibold">60</div>
                            <div class="text-gray-400">Cible</div>
                        </div>
                    </div>
                </div>
            `;
        } else {
            fpsEl.innerHTML = `
                <div class="flex items-center justify-center h-32">
                    <div class="text-center">
                        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-purple-500 mx-auto mb-2"></div>
                        <p class="text-gray-400 text-sm">Tests FPS en cours...</p>
                    </div>
                </div>
            `;
        }

        // A11y - Affichage avec badge visuel
        const a11yEl = document.getElementById("a11y-result");
        if (a11y != null) {
            const statusIcon = a11y.passed ? '‚úÖ' : '‚ùå';
            const statusColor = a11y.passed ? 'text-green-400' : 'text-red-400';
            const badgeColor = a11y.passed ? 'bg-green-500' : 'bg-red-500';
            const statusText = a11y.passed ? 'Conforme' : 'Non conforme';
            a11yEl.innerHTML = `
                <div class="space-y-4">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-3">
                            <div class="w-12 h-12 ${badgeColor} rounded-full flex items-center justify-center text-white text-xl font-bold">
                                ${a11y.passed ? '‚ôø' : '‚ö†Ô∏è'}
                            </div>
                            <div>
                                <div class="text-lg font-bold ${statusColor}">${statusText}</div>
                                <div class="text-xs text-gray-400">Reduced Motion</div>
                            </div>
                        </div>
                        <div class="text-3xl">${statusIcon}</div>
                    </div>
                    <div class="p-3 bg-gray-800 rounded-lg">
                        <div class="text-xs text-gray-300 mb-2">
                            ${a11y.passed ?
                                'üéØ Les animations respectent prefers-reduced-motion' :
                                '‚ùó Certaines animations ignorent les pr√©f√©rences utilisateur'
                            }
                        </div>
                        <div class="text-xs text-gray-500">
                            Test automatique de la directive CSS prefers-reduced-motion
                        </div>
                    </div>
                    ${a11y.passed ?
                        '<div class="flex items-center space-x-2 text-xs text-green-400"><span class="pulse-dot bg-green-400"></span><span>Accessibilit√© optimis√©e</span></div>' :
                        '<div class="flex items-center space-x-2 text-xs text-red-400"><span class="pulse-dot bg-red-400"></span><span>Am√©liorations n√©cessaires</span></div>'
                    }
                </div>
            `;
        } else {
            a11yEl.innerHTML = `
                <div class="flex items-center justify-center h-32">
                    <div class="text-center">
                        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-purple-500 mx-auto mb-2"></div>
                        <p class="text-gray-400 text-sm">Test accessibilit√© en cours...</p>
                    </div>
                </div>
            `;
        }

        // Datasets - Affichage avec gauge visuel
        const datasetEl = document.getElementById("dataset-result");
        if (datasets?.degradation != null && datasets.degradation !== 'N/A') {
            const degradation = parseFloat(datasets.degradation);
            const isGood = degradation < 5;
            const isMedium = degradation < 15;
            const statusIcon = isGood ? '‚úÖ' : isMedium ? '‚ö†Ô∏è' : '‚ùå';
            const statusColor = isGood ? 'text-green-400' : isMedium ? 'text-yellow-400' : 'text-red-400';
            const gaugeColor = isGood ? '#10b981' : isMedium ? '#f59e0b' : '#ef4444';
            const statusText = isGood ? 'Excellent' : isMedium ? 'Acceptable' : 'Probl√©matique';
            const gaugePercent = Math.min(100, (degradation / 20) * 100);
            const gaugeDasharray = `${gaugePercent * 1.88} 188`;

            datasetEl.innerHTML = `
                <div class="space-y-4">
                    <div class="flex items-center justify-between">
                        <div class="relative">
                            <svg class="w-16 h-16 transform -rotate-90" viewBox="0 0 64 64">
                                <circle cx="32" cy="32" r="30" stroke="rgba(255,255,255,0.1)" stroke-width="4" fill="none"/>
                                <circle cx="32" cy="32" r="30" stroke="${gaugeColor}"
                                        stroke-width="4" fill="none" stroke-linecap="round"
                                        stroke-dasharray="${gaugeDasharray}" class="transition-all duration-1000 ease-out"/>
                            </svg>
                            <div class="absolute inset-0 flex items-center justify-center">
                                <div class="text-center">
                                    <div class="text-sm font-bold ${statusColor}">${degradation.toFixed(1)}%</div>
                                </div>
                            </div>
                        </div>
                        <div class="flex-1 ml-4 space-y-1">
                            <div class="flex items-center justify-between">
                                <span class="text-sm font-medium">Scalabilit√©</span>
                                <span class="text-2xl">${statusIcon}</span>
                            </div>
                            <div class="text-xs ${statusColor} font-medium">${statusText}</div>
                            <div class="text-xs text-gray-400">Objectif: < 5%</div>
                        </div>
                    </div>
                    <div class="grid grid-cols-3 gap-2 text-center text-xs">
                        <div class="p-2 bg-gray-800 rounded">
                            <div class="text-green-400 font-semibold">< 5%</div>
                            <div class="text-gray-400">Excellent</div>
                        </div>
                        <div class="p-2 bg-gray-800 rounded">
                            <div class="text-yellow-400 font-semibold">5-15%</div>
                            <div class="text-gray-400">Acceptable</div>
                        </div>
                        <div class="p-2 bg-gray-800 rounded">
                            <div class="text-red-400 font-semibold">> 15%</div>
                            <div class="text-gray-400">Critique</div>
                        </div>
                    </div>
                </div>
            `;
        } else {
            datasetEl.innerHTML = `
                <div class="space-y-4">
                    <div class="flex items-center justify-between">
                        <div class="w-16 h-16 bg-gray-700 rounded-full flex items-center justify-center">
                            <span class="text-2xl">üîç</span>
                        </div>
                        <div class="flex-1 ml-4 space-y-1">
                            <div class="text-lg font-bold text-gray-400">Donn√©es manquantes</div>
                            <div class="text-xs text-gray-500">Tests de scalabilit√© requis</div>
                        </div>
                    </div>
                    <div class="p-3 bg-gray-800 rounded-lg border border-dashed border-gray-600">
                        <div class="text-xs text-gray-400 text-center">
                            Ex√©cutez <code class="bg-gray-700 px-1 rounded">npm run test:datasets</code> pour g√©n√©rer les m√©triques
                        </div>
                    </div>
                </div>
            `;
        }
    }

    function renderAudit(audit) {
        const el = document.getElementById('audit-rncp-content');
        const perfEl = document.getElementById('audit-performance');
        const accEl = document.getElementById('audit-accessibility');
        const ecoEl = document.getElementById('audit-eco');
        const qualityEl = document.getElementById('audit-quality');

        if (!audit) { el.innerHTML += '<p class="mt-2 text-yellow-400 text-xs">Impossible de charger audit-complet.</p>'; return; }
        el.innerHTML += `<p class='mt-2 text-xs opacity-50'>Charg√©: ${new Date(audit.timestamp).toLocaleString('fr-FR')}</p>`;

        // Performance
        perfEl.innerHTML = `<ul class='text-sm space-y-1'>${[
            audit.lighthouse?.scores?.performance!=null?`<li>Perf Lighthouse: <strong>${audit.lighthouse.scores.performance}%</strong></li>`:null,
            audit.fps?.avgOverall!=null?`<li>FPS moyen: <strong>${audit.fps.avgOverall}</strong> ${audit.fps.allPassed?'‚úÖ':'‚ö†Ô∏è'}</li>`:null,
            audit.datasets?.degradation!=null?`<li>D√©gradation datasets: <strong>${audit.datasets.degradation}%</strong></li>`:null
        ].filter(Boolean).join('')}</ul>`;

        // Accessibilit√©
        accEl.innerHTML = `<ul class='text-sm space-y-1'>${[
            audit.lighthouse?.scores?.accessibility!=null?`<li>Accessibilit√© Lighthouse: <strong>${audit.lighthouse.scores.accessibility}%</strong></li>`:null,
            audit.a11y?`<li>Reduced Motion: ${audit.a11y.passed?'‚úÖ Conforme':'‚ùå Non conforme'}</li>`:null,
            audit.daltonisme?`<li>Daltonisme: ${Object.entries(audit.daltonisme).map(([k,v])=>`${k}:${v}`).join(', ')}</li>`:null,
            audit.riskLevels?`<li>WCAG Risk Levels: Critique ${audit.riskLevels.critique}, √âlev√© ${audit.riskLevels.eleve}, Moyen ${audit.riskLevels.moyen}, Faible ${audit.riskLevels.faible}</li>`:null
        ].filter(Boolean).join('')}</ul>`;

        // √âco
        ecoEl.innerHTML = audit.eco ? `<p class='text-sm'>√âco (indicateurs principaux): <code>${Object.keys(audit.eco).slice(0,5).join(', ')}</code></p>` : `<p class='text-xs opacity-60'>Absent</p>`;

        // Coverage
        qualityEl.innerHTML = audit.coverage && audit.coverage.statements!=null ? `<p class='text-sm'>Statements: <strong>${audit.coverage.statements}%</strong> | Fonctions: ${audit.coverage.functions??'N/A'}% | Branches: ${audit.coverage.branches??'N/A'}%</p>` : `<p class='text-xs opacity-60'>Couverture non disponible</p>`;
    }

    async function loadCoverage() {
        // Chargement et traitement des donn√©es de couverture - CORRIG√â pour utiliser le bon chemin
        const candidates = [
            './coverage/coverage-final.json', // Local - dossier metrics
            '../../../coverage/coverage-final.json', // Racine du projet depuis metrics
            '../../coverage/coverage-final.json', // Alternative
            'https://sandrinecipolla.github.io/stockHub_V2_front/coverage/coverage-final.json' // GitHub Pages (si publi√©)
        ];
        let data = null;
        let usedUrl = null;

        for (const url of candidates) {
            try {
                console.log(`Tentative de chargement: ${url}`);
                const r = await fetch(url);
                if (r.ok) {
                    data = await r.json();
                    usedUrl = url;
                    console.log(`Coverage charg√©e depuis: ${url}`);
                    break;
                } else {
                    console.log(`√âchec ${url}: ${r.status}`);
                }
            } catch (e) {
                console.log(`Erreur ${url}:`, e.message);
            }
        }

        const container = document.getElementById('coverage-content');
        if (!data) {
            container.innerHTML = `
                <p class="text-red-400">‚ùå Impossible de charger coverage-final.json</p>
                <p class="text-xs opacity-60 mt-2">Tentatives effectu√©es :</p>
                <ul class="text-xs opacity-60 mt-1">
                    ${candidates.map(url => `<li>‚Ä¢ ${url}</li>`).join('')}
                </ul>
                <p class="text-xs opacity-60 mt-2">Assurez-vous que les tests de couverture ont √©t√© ex√©cut√©s avec <code>npm run test:coverage</code></p>
            `;
            return;
        }

        const GROUP_RULES = [
            { id:'dashboard', label:'Dashboard', help:'Vue principale et widgets du tableau de bord', match:f=> /pages[\\\/]Dashboard|Dashboard/i.test(f) },
            { id:'analytics', label:'Analytics', help:'Pages et logique analytique', match:f=> /pages[\\\/]Analytics|analytics/i.test(f) },
            { id:'components', label:'Components UI', help:'Composants r√©utilisables (src/components)', match:f=> /components[\\\/]/.test(f) },
            { id:'hooks', label:'Hooks', help:'Hooks personnalis√©s (src/hooks)', match:f=> /hooks[\\\/]/.test(f) },
            { id:'utils', label:'Utils', help:'Fonctions utilitaires diverses', match:f=> /utils[\\\/]/.test(f) },
            { id:'contexts', label:'Contexts', help:'Gestion des contextes React (src/contexts)', match:f=> /contexts[\\\/]/.test(f) },
            { id:'data', label:'Data Layer', help:'Acc√®s et mod√®les de donn√©es (src/data)', match:f=> /data[\\\/]/.test(f) }
        ];

        let totalStatements=0, coveredStatements=0;
        const fileCoverages=[];
        for (const [fileName, fileObj] of Object.entries(data)) {
            if (!fileObj || !fileObj.s) continue;
            const sVals = Object.values(fileObj.s);
            const fileStatements = sVals.length;
            const fileCoveredStatements = sVals.filter(v=>v>0).length;
            totalStatements += fileStatements;
            coveredStatements += fileCoveredStatements;
            if (fileStatements>0) {
                fileCoverages.push({ raw:fileName, file: fileName.replace(/^.*src[\\\/]/,''), statements:fileStatements, covered:fileCoveredStatements });
            }
        }
        const pct=(c,t)=> t===0?0:(c/t*100);

        const groupMap = GROUP_RULES.map(g=>({ id:g.id, label:g.label, help:g.help, statements:0, covered:0 }));
        for (const fc of fileCoverages) {
            const match = GROUP_RULES.find(gr=> gr.match(fc.raw));
            if (match) {
                const target = groupMap.find(g=>g.id===match.id);
                target.statements += fc.statements;
                target.covered += fc.covered;
            }
        }
        const effectiveGroups = groupMap.filter(g=> g.statements>0).map(g=> ({...g, pct: pct(g.covered,g.statements)}));
        const sortedGroups = [...effectiveGroups].sort((a,b)=> a.pct - b.pct);
        const bestGroups = [...effectiveGroups].sort((a,b)=> b.pct - a.pct).slice(0,3);

        const withPctFiles = fileCoverages.map(f=> ({...f, pct: pct(f.covered,f.statements)}));
        const worst = withPctFiles.filter(f=> f.statements>=5).sort((a,b)=> a.pct - b.pct).slice(0,5);
        const best = withPctFiles.filter(f=> f.statements>=5).sort((a,b)=> b.pct - a.pct).slice(0,5);

        const colorFor = p => p>=85? 'text-green-400' : p>=70? 'text-yellow-400' : 'text-red-400';
        const bar = p => `<div class='h-2 w-full bg-white/10 rounded'><div class='h-2 rounded bg-[var(--sh-purple-500)]' style='width:${p.toFixed(1)}%'></div></div>`;
        const listBlock = (title, arr) => arr.length ? `<div class='mt-8'><h3 class='font-semibold mb-2 text-sm'>${title}</h3><ul class='space-y-1 text-xs'>${arr.map(f=> `<li class='flex justify-between'><span class='truncate max-w-[65%]' title='${f.file}'>${f.file}</span><span class='${colorFor(f.pct)}'>${f.pct.toFixed(1)}%</span></li>`).join('')}</ul></div>` : '';

        const groupBlock = effectiveGroups.length ? `
          <div class='mt-8'>
            <h3 class='font-semibold mb-2 text-sm'>Couverture par domaine fonctionnel</h3>
            <div class='space-y-3'>
              ${sortedGroups.map(g=>`
                <div>
                  <div class='flex justify-between mb-0.5'>
                    <span class='tooltip-wrapper' tabindex='0'>${g.label} <span class='tooltip-box'>${g.help}</span></span>
                    <span class='${colorFor(g.pct)} text-xs'>${g.pct.toFixed(1)}%</span>
                  </div>
                  ${bar(g.pct)}
                </div>
              `).join('')}
            </div>
            <div class='mt-4 text-xs opacity-60'>Top domaines bien couverts : ${bestGroups.map(g=> g.label + ' (' + g.pct.toFixed(0)+'%)').join(', ')}</div>
          </div>`
          : '<div class="mt-8 text-xs opacity-60">Aucun regroupement fonctionnel d√©tect√© (v√©rifiez vos dossiers).</div>';

        // === Ajout r√®gles fonctionnalit√©s utilisateur ===
        const FEATURE_RULES = [
          { id:'crud', label:'Gestion Stocks (CRUD)', help:'Cr√©ation, mise √† jour, filtrage des stocks (useStocks, Dashboard, config)', match:f=> /(hooks[\\\/]useStocks|pages[\\\/]Dashboard|stockConfig|stockData)/i.test(f) },
          { id:'prediction', label:'Pr√©dictions IA', help:'Simulation & composant pr√©diction (mlSimulation, StockPrediction, aiPredictions)', match:f=> /(utils[\\\/]mlSimulation|components[\\\/]ai[\\\/]StockPrediction|utils[\\\/]aiPredictions)/i.test(f) },
          { id:'alerts', label:'Alertes & Statuts', help:'Badges statut, calcul niveaux de risque, config', match:f=> /(StatusBadge|statusBadge|stockConfig|risk-levels|determineRiskLevel)/i.test(f) },
          { id:'preferences', label:'Pr√©f√©rences & Th√®me', help:'Gestion th√®me & pr√©f√©rences utilisateur', match:f=> /(contexts[\\\/]theme)/i.test(f) },
          { id:'dataLayer', label:'Couche Donn√©es', help:'Structures & acc√®s (src/data)', match:f=> /src[\\\/]data[\\\/]/i.test(f) },
          { id:'support', label:'Support g√©n√©rique', help:'Hooks/Utils techniques hors CRUD sp√©cifique', match:f=> /(src[\\\/]utils|src[\\\/]hooks)/i.test(f) }
        ];
        function aggregateByRules(rules, files) {
          const groups = rules.map(r=> ({ ...r, statements:0, covered:0, files:[] }));
          for (const fc of files) {
            const rule = rules.find(r=> r.match(fc.raw));
            if (rule) {
              const g = groups.find(gr=> gr.id===rule.id);
              g.statements += fc.statements;
              g.covered += fc.covered;
              g.files.push(fc);
            }
          }
          return groups.filter(g=> g.statements>0).map(g=> ({ ...g, pct: pct(g.covered,g.statements) }));
        }
        const featureGroups = aggregateByRules(FEATURE_RULES, fileCoverages);
        const sortedFeatureGroups = [...featureGroups].sort((a,b)=> a.pct - b.pct);
        const topFeatureGroups = [...featureGroups].sort((a,b)=> b.pct - a.pct).slice(0,3);
        const featureBlock = featureGroups.length ? `
          <div class='mt-10'>
            <h3 class='font-semibold mb-2 text-sm'>Couverture par fonctionnalit√© (vue utilisateur)</h3>
            <div class='space-y-3'>
              ${sortedFeatureGroups.map(g=> {
                const examples = g.files.sort((a,b)=> b.statements - a.statements).slice(0,2).map(f=> f.file).join(', ');
                return `<div>
                  <div class='flex justify-between mb-0.5'>
                    <span class='tooltip-wrapper' tabindex='0'>${g.label} <span class='tooltip-box'>${g.help}${examples?`<br/><em>Exemples: ${examples}</em>`:''}</span></span>
                    <span class='${colorFor(g.pct)} text-xs'>${g.pct.toFixed(1)}%</span>
                  </div>
                  ${bar(g.pct)}
                </div>`;
              }).join('')}
            </div>
            <div class='mt-4 text-xs opacity-60'>Fonctionnalit√©s mieux couvertes : ${topFeatureGroups.map(g=> g.label + ' (' + g.pct.toFixed(0)+'%)').join(', ')}</div>
          </div>` : `<div class='mt-10 text-xs opacity-60'>Pas de regroupement fonctionnel d√©tect√© (r√®gles non satisfaites).</div>`;

        const globalPct = pct(coveredStatements,totalStatements);
        container.innerHTML = `
          <div class='mb-4'>
            <p class='text-lg'>Couverture globale (instructions) : <span class='font-semibold ${colorFor(globalPct)}'>${globalPct.toFixed(1)}%</span></p>
            <p class='text-xs opacity-60'>Source: ${usedUrl}</p>
            <p class='text-xs opacity-60 flex gap-3'>
              <span><span class='inline-block w-2 h-2 rounded-full bg-green-400 align-middle'></span> ‚â•85% bon</span>
              <span><span class='inline-block w-2 h-2 rounded-full bg-yellow-400 align-middle'></span> 70‚Äì84% moyen</span>
              <span><span class='inline-block w-2 h-2 rounded-full bg-red-400 align-middle'></span> <70% faible</span>
            </p>
          </div>
          ${groupBlock}
          ${featureBlock}
          ${listBlock('Top qualit√© (meilleurs fichiers)', best)}
          ${listBlock('Priorit√©s d\'am√©lioration (faible couverture)', worst)}
          <p class='text-xs opacity-50 mt-4'>Source : coverage-final.json ‚Äì regroupements dossiers & fonctionnalit√©s heuristiques.</p>
        `;
    }
    // Appels
    loadCoverage();
    loadAllData();
</script>
</body>
</html>
